<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Чередование: длинный → 10с</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing:border-box; }
    body { margin:0; min-height:100svh; background:#0b1220; color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; display:grid; grid-template-rows: 1fr auto; }
    /* Вся «сцена» — большой отсчёт и название интервала */
    .stage { display:grid; place-items:center; text-align:center; padding:24px; }
    .left { font-size: clamp(56px, 12vw, 160px); line-height:1; font-weight:800; letter-spacing:0.02em; font-variant-numeric:tabular-nums; }
    .leg  { margin-top:14px; font-size: clamp(18px, 3.2vw, 36px); opacity:.9; }
    .led  { width:14px; height:14px; border-radius:50%; background:#374151; display:inline-block; margin-left:10px; vertical-align:middle; box-shadow:0 0 0 0 rgba(16,185,129,0); }
    .led.on { background:#10b981; animation:pulse .9s ease-out; }
    @keyframes pulse { from { box-shadow:0 0 0 0 rgba(16,185,129,.7);} to { box-shadow:0 0 0 20px rgba(16,185,129,0);} }

    /* Панель управления внизу */
    .controls { background:#0f172a; border-top:1px solid #1f2937; padding:12px 14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; }
    button { appearance:none; border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer; }
    #start { background:#10b981; color:#05291f; }
    #stop  { background:#ef4444; color:#3b0a0a; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .field { display:flex; align-items:center; gap:8px; padding:8px 10px; background:#0b1324; border:1px solid #1f2937; border-radius:12px; }
    .field input[type="number"] { width:84px; padding:6px 10px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; font-weight:700; }
    .k { color:#9ca3af; font-size:14px; }
    input[type="range"] { width:140px; }
    label.switch { display:flex; align-items:center; gap:8px; padding:8px 10px; background:#0b1324; border:1px solid #1f2937; border-radius:12px; }
  </style>
</head>
<body>
  <main class="stage">
    <div class="left" id="left">—</div>
    <div class="leg" id="leg">— <span class="led" id="led"></span></div>
  </main>

  <footer class="controls">
    <button id="start">Старт</button>
    <button id="stop" disabled>Стоп</button>

    <div class="field">
      <span class="k">Длинный интервал (сек):</span>
      <input id="longSec" type="number" min="5" max="600" step="1" value="30" />
    </div>

    <label class="field">
      <span class="k">Громкость</span>
      <input id="vol" type="range" min="0" max="150" value="100" />
    </label>

    <label class="switch">
      <input id="boost" type="checkbox" checked />
      <span class="k">Усиление +</span>
    </label>

    <button id="test" title="Проверить звук">Тест-бип</button>
  </footer>

  <script>
    // ===== Аудио (громкий, «проникающий») =====
    let ctx=null, preGain=null, compressor=null, masterGain=null;

    function ensureAudio(){
      if(!ctx){
        const AC = window.AudioContext || window.webkitAudioContext;
        ctx = new AC();
        preGain = ctx.createGain();

        compressor = ctx.createDynamicsCompressor();
        compressor.threshold.setValueAtTime(-28, ctx.currentTime);
        compressor.knee.setValueAtTime(24, ctx.currentTime);
        compressor.ratio.setValueAtTime(12, ctx.currentTime);
        compressor.attack.setValueAtTime(0.002, ctx.currentTime);
        compressor.release.setValueAtTime(0.15, ctx.currentTime);

        masterGain = ctx.createGain();
        masterGain.gain.value = 1.0;

        preGain.connect(compressor).connect(masterGain).connect(ctx.destination);

        applyVolumeFromUI();
        applyBoostFromUI();
      }
      if (ctx.state === 'suspended') ctx.resume();
    }

    function applyVolumeFromUI(){
      if(!preGain) return;
      const v = document.getElementById('vol').value;
      const gain = Math.min(2.5, v/60);
      preGain.gain.setTargetAtTime(gain, ctx.currentTime, 0.01);
    }
    function applyBoostFromUI(){
      if(!compressor) return;
      const on = document.getElementById('boost').checked;
      if(on){
        compressor.threshold.setValueAtTime(-30, ctx.currentTime);
        compressor.knee.setValueAtTime(26, ctx.currentTime);
        compressor.ratio.setValueAtTime(14, ctx.currentTime);
        compressor.attack.setValueAtTime(0.0015, ctx.currentTime);
        compressor.release.setValueAtTime(0.12, ctx.currentTime);
      }else{
        compressor.threshold.setValueAtTime(-18, ctx.currentTime);
        compressor.knee.setValueAtTime(20, ctx.currentTime);
        compressor.ratio.setValueAtTime(8, ctx.currentTime);
        compressor.attack.setValueAtTime(0.003, ctx.currentTime);
        compressor.release.setValueAtTime(0.20, ctx.currentTime);
      }
    }

    function beepPattern(kindSec){
      const led = document.getElementById('led');
      led.classList.remove('on'); void led.offsetWidth; led.classList.add('on');

      const isLong = (kindSec !== 10); // длинный интервал против короткого (10с)
      const reps = isLong ? 3 : 2;
      const base = isLong ? 1200 : 2400;
      const dur  = isLong ? 150  : 130;
      const gap  = 80;

      for(let i=0;i<reps;i++){
        const t = ctx.currentTime + i*(dur+gap)/1000;
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(base, t);
        osc.frequency.linearRampToValueAtTime(base*1.12, t + dur/1000);

        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(1.0, t+0.008);
        g.gain.exponentialRampToValueAtTime(0.0001, t+dur/1000);

        osc.connect(g).connect(preGain);
        osc.start(t);
        osc.stop(t + dur/1000);
      }
    }

    // ===== Логика: длинный → 10 → длинный → … =====
    let running=false;
    const shortSec = 10;
    let longSec = 30;

    let nextLegType = 'long';   // 'long' | 'short'
    let currentLegType = null;  // что сейчас идёт
    let legStartTs = null;      // ms, начало текущей ноги
    let legLenSec = null;       // длина текущей ноги (в секундах зафиксирована на старте ноги)
    let targetTs = null;        // когда прозвучит сигнал (ms)
    let timeoutId = null;
    let tickId = null;

    function scheduleNext(){
      if(!running) return;
      const now = Date.now();

      currentLegType = nextLegType;
      legLenSec = (currentLegType==='long' ? longSec : shortSec);
      legStartTs = now;
      targetTs = legStartTs + legLenSec*1000;

      clearTimeout(timeoutId);
      timeoutId = setTimeout(()=>{
        beepPattern(legLenSec);
        nextLegType = (currentLegType==='long') ? 'short' : 'long';
        scheduleNext();
      }, legLenSec*1000);

      updateLegLabel();
    }

    function start(){
      if(running) return;
      ensureAudio();
      running = true;
      nextLegType = 'long';
      scheduleNext();
      startUI();
      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
    }
    function stop(){
      running = false;
      clearTimeout(timeoutId);
      stopUI();
      document.getElementById('start').disabled = false;
      document.getElementById('stop').disabled = true;
      document.getElementById('left').textContent = '—';
      document.getElementById('leg').textContent  = '—';
    }

    // Пересчёт, если меняют «длинный интервал» во время длинной ноги
    function maybeAdjustCurrentLeg(){
      const inputVal = Math.max(5, Math.min(600, Number(document.getElementById('longSec').value || 30)));
      longSec = inputVal;

      if(!running) return;
      if(currentLegType !== 'long') return;

      const now = Date.now();
      const newTarget = legStartTs + longSec*1000;
      const remaining = Math.max(0, newTarget - now);

      clearTimeout(timeoutId);
      targetTs = newTarget;
      timeoutId = setTimeout(()=>{
        beepPattern(longSec);
        nextLegType = 'short';
        scheduleNext();
      }, remaining);

      updateLegLabel();
    }

    // ===== UI =====
    function fmtLeft(ms){
      ms = Math.max(0, ms);
      const s = Math.ceil(ms/1000);
      const m = Math.floor(s/60);
      const r = s % 60;
      return (m ? `${m}м ` : '') + `${r}с`;
    }
    function startUI(){
      clearInterval(tickId);
      tickId = setInterval(()=>{
        if(running && targetTs){
          const leftMs = targetTs - Date.now();
          document.getElementById('left').textContent = fmtLeft(leftMs);
        }
      }, 150);
      updateLegLabel();
    }
    function stopUI(){ clearInterval(tickId); tickId=null; }

    function updateLegLabel(){
      const name = (currentLegType === 'short') ? `идём ${shortSec} с` : `идём ${longSec} с`;
      document.getElementById('leg').firstChild
        ? document.getElementById('leg').firstChild.nodeValue = name+' '
        : document.getElementById('leg').insertBefore(document.createTextNode(name+' '), document.getElementById('leg').firstChild);
    }

    // ===== События =====
    document.getElementById('start').addEventListener('click', start);
    document.getElementById('stop').addEventListener('click', stop);
    document.getElementById('vol').addEventListener('input', ()=>{ ensureAudio(); applyVolumeFromUI(); });
    document.getElementById('boost').addEventListener('change', ()=>{ ensureAudio(); applyBoostFromUI(); });
    document.getElementById('test').addEventListener('click', ()=>{ ensureAudio(); beepPattern(10); });
    document.getElementById('longSec').addEventListener('change', maybeAdjustCurrentLeg);
    document.getElementById('longSec').addEventListener('input', ()=>{ // живое обновление подписи
      const v = Number(document.getElementById('longSec').value||30);
      longSec = Math.max(5, Math.min(600, v));
      if(currentLegType==='long') updateLegLabel();
    });

    window.addEventListener('pagehide', stop);
  </script>
</body>
</html>
