<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>AI Чат</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./assets/css/libs/bootstrap-icons.css">

    <style>
        body {
            background: linear-gradient(135deg, #d9f7ff, #eaf3ff, #ffffff);
            font-family: 'Nunito', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* Offcanvas */
        .offcanvas {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 75%;
            max-width: 280px;
            background: #fff;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.25);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }

        .offcanvas-left {
            left: 0;
            transform: translateX(-100%);
        }

        .offcanvas.show {
            transform: translateX(0);
        }

        .chat-box-h {
            max-height: calc(100vh - 110px);
        }

        @keyframes popup-scale {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-popup {
            animation: popup-scale 0.25s ease-out;
        }

        /* === USER MESSAGE (мягкий редизайн) === */
        .user-bubble {
            position: relative;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            color: #0f172a;
            border-radius: 14px;
            padding: 10px 14px;
            border: 1px solid rgba(147, 197, 253, 0.6);
            box-shadow: 0 2px 6px rgba(30, 64, 175, 0.05),
            inset 0 0 0 1px rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(6px);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        /* лёгкий хвостик справа снизу */
        .user-bubble::after {
            content: "";
            position: absolute;
            right: -5px;
            bottom: 12px;
            width: 10px;
            height: 10px;
            background: inherit;
            transform: rotate(45deg);
            border-right: 1px solid rgba(147, 197, 253, 0.6);
            border-bottom: 1px solid rgba(147, 197, 253, 0.6);
        }

        /* hover */
        @media (hover: hover) {
            .user-bubble:hover {
                box-shadow: 0 4px 12px rgba(30, 64, 175, 0.08),
                inset 0 0 0 1px rgba(255, 255, 255, 0.35);
                transform: translateY(-1px);
            }
        }

        /* === ASSISTANT MESSAGE (мягкий glass) === */
        .assistant-bubble {
            position: relative;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            color: #334155; /* slate-700 */
            border-radius: 14px;
            padding: 10px 14px;
            border: 1px solid rgba(148, 163, 184, 0.45); /* slate-400 */
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.05), /* мягкая внешняя тень */ inset 0 0 0 1px rgba(255, 255, 255, 0.35); /* светлая внутренняя кромка */
            backdrop-filter: blur(6px);
            transition: box-shadow .2s ease, transform .2s ease;
        }

        /* «хвостик» слева снизу */
        .assistant-bubble::after {
            content: "";
            position: absolute;
            left: -5px;
            bottom: 12px;
            width: 10px;
            height: 10px;
            background: inherit;
            transform: rotate(45deg);
            border-left: 1px solid rgba(148, 163, 184, 0.45);
            border-bottom: 1px solid rgba(148, 163, 184, 0.45);
        }

        /* hover — чуть выразительнее */
        @media (hover: hover) {
            .assistant-bubble:hover {
                box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08),
                inset 0 0 0 1px rgba(255, 255, 255, 0.45);
                transform: translateY(-1px);
            }
        }

        .chat-item {
            border-radius: 6px;
            transition: background-color .15s ease;
        }

        .chat-item:hover {
            background: #e5e7eb;
        }

        .chat-item.active {
            background: #cbd5e1;
        }

        .chat-item.active:hover {
            background: #94a3b8;
        }

        #diagram-modal {
            z-index: 40 !important;
        }

        .diagram-d {
            min-width: 60%;
            min-height: 80%;
            max-height: 90%;
        }

        @media (max-width: 1024px) {
            .diagram-d {
                min-width: 80%;
                min-height: 90%;
            }
        }

        @media (max-width: 768px) {
            .diagram-d {
                min-width: 90%;
                min-height: 90%;
                max-height: 90%;
            }
        }

        @media (max-width: 480px) {
            .diagram-d {
                min-width: 90%;
                min-height: 90vh;
                max-height: 90vh;
            }
        }

        #success-popup, #error-popup, #loader {
            z-index: 100 !important;
        }

        #diagram-content svg,
        #diagram-content .mermaid > svg {
            display: block;
            max-width: 100%;
            height: auto;
        }

        #diagram-content svg {
            margin: 0;
        }

        #diagram-content .svg-stage {
            position: absolute;
            inset: 0;
        }

        #diagram-content .svg-stage > svg {
            display: block;
            width: 100% !important;
            height: 100% !important;
            overflow: visible;
        }

        /* --- ТАБЫ ДЛЯ ЛЕВОЙ ПАНЕЛИ И МОБИЛЬНОГО OFFCANVAS --- */
        .tabs {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100%;
        }

        .tab-controls {
            display: grid;
            grid-auto-flow: column;
            gap: .25rem;
            background: rgba(17, 24, 39, .04);
            padding: .35rem;
            border-radius: .75rem;
            border: 1px solid rgba(0, 0, 0, .06);
        }

        .tab-controls label {
            text-align: center;
            font-size: .75rem;
            padding: .5rem .6rem;
            border-radius: .65rem;
            cursor: pointer;
            transition: all .15s ease;
            color: #374151;
            user-select: none;
            white-space: nowrap;
        }

        .tab-controls label:hover {
            background: rgba(0, 0, 0, .05);
        }

        .tab-content {
            position: relative;
            overflow: hidden;
            border-radius: .75rem;
            margin-top: .5rem;
            border: 1px solid rgba(0, 0, 0, .06);
            background: #ffffffa8;
        }

        .tab-pane {
            display: none;
            height: calc(100% - 0px);
            overflow: auto;
            padding: .5rem;
        }

        .tab-radio {
            display: none;
        }

        /* Активные вкладки — desktop */
        #tab-chats:checked ~ .tab-controls label[for="tab-chats"],
        #tab-diagrams:checked ~ .tab-controls label[for="tab-diagrams"],
        #tab-files:checked ~ .tab-controls label[for="tab-files"] {
            background: linear-gradient(135deg, #a7f3d0, #86efac);
            color: #065f46;
            box-shadow: inset 0 0 0 1px rgba(6, 95, 70, .2);
        }

        #tab-chats:checked ~ .tab-content .pane-chats,
        #tab-diagrams:checked ~ .tab-content .pane-diagrams,
        #tab-files:checked ~ .tab-content .pane-files {
            display: block;
        }

        /* Активные вкладки — mobile (offcanvas-left) */
        #mtab-chats:checked ~ .m-tab-controls label[for="mtab-chats"],
        #mtab-diagrams:checked ~ .m-tab-controls label[for="mtab-diagrams"],
        #mtab-files:checked ~ .m-tab-controls label[for="mtab-files"] {
            background: #e2e8f0;
            color: #0f172a;
        }

        #mtab-chats:checked ~ .m-tab-content .m-pane-chats,
        #mtab-diagrams:checked ~ .m-tab-content .m-pane-diagrams,
        #mtab-files:checked ~ .m-tab-content .m-pane-files {
            display: block;
        }

        /* Правую панель визуально скрываем (оставляем в DOM, чтобы не ломать JS) */
        #right-sidebar {
            display: none !important;
        }

        /* --- LIVE PREVIEW --- */
        #live-preview {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 130; /* выше #loader (100) */
            width: min(900px, 92vw);
            height: min(60vh, 560px); /* фиксированная высота с ограничением */
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 14px 40px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
            overflow: hidden; /* скроллим только внутреннюю область */
            display: none; /* по умолчанию скрыт */
        }

        /* показываем через JS */
        #live-preview.show {
            display: flex;
            flex-direction: column;
        }

        /* шапка */
        #live-preview .lp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: linear-gradient(180deg, rgba(240, 253, 244, .9), rgba(255, 255, 255, .6));
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            font-weight: 700;
            font-size: 0.95rem;
            color: #065f46;
        }

        /* контентная область со скроллом */
        #live-preview .lp-body {
            flex: 1;
            overflow: auto; /* скроллим здесь */
            padding: 12px 14px;
            font-size: 0.95rem;
            line-height: 1.55;
            color: #0f172a;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* футер (подсказка) */
        #live-preview .lp-footer {
            padding: 8px 12px;
            font-size: 12px;
            color: #64748b;
            border-top: 1px dashed rgba(0, 0, 0, .08);
            background: rgba(255, 255, 255, .6);
        }

        /* плейсхолдер, пока текста нет */
        #live-preview.empty .lp-body {
            display: grid;
            place-items: center;
            color: #64748b;
        }

        #live-preview .lp-placeholder {
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
            font-size: 0.9rem;
        }

        #live-preview .lp-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34d399;
            animation: lp-blink 1.2s infinite ease-in-out;
        }

        #live-preview .lp-dot:nth-child(2) {
            animation-delay: .15s;
        }

        #live-preview .lp-dot:nth-child(3) {
            animation-delay: .3s;
        }

        @keyframes lp-blink {
            0%, 80%, 100% {
                opacity: .2;
                transform: translateY(0);
            }
            40% {
                opacity: 1;
                transform: translateY(-3px);
            }
        }

        /* кнопка закрытия (на случай, если хочется вручную скрыть) */
        #live-preview .lp-close {
            appearance: none;
            border: 0;
            background: transparent;
            cursor: pointer;
            padding: 4px;
            border-radius: 8px;
            color: #334155;
        }

        #live-preview .lp-close:hover {
            background: rgba(0, 0, 0, .06);
        }

        /* === PROMPT INPUT (glass mellow) === */
        #prompt-input {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%) !important;
            border: 1px solid rgba(148, 163, 184, 0.45) !important; /* slate-400 */
            border-radius: 14px !important;
            padding: 12px 14px !important;
            color: #0f172a !important;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.05),
            inset 0 0 0 1px rgba(255, 255, 255, 0.35) !important;
            transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
            min-height: 44px;
            max-height: 40vh; /* защитный потолок */
            overflow: auto; /* когда текст очень длинный */
        }

        #prompt-input::placeholder {
            color: #94a3b8; /* slate-400 */
        }

        #prompt-input:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.55) !important; /* sky/blue оттенок */
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.10),
            0 0 0 4px rgba(59, 130, 246, 0.12),
            inset 0 0 0 1px rgba(255, 255, 255, 0.45) !important;
            background: linear-gradient(135deg, #f9fbff 0%, #ffffff 100%) !important;
        }

        /* тёмная тема (если используете .dark) */
        .dark #prompt-input {
            background: linear-gradient(135deg, #0b1220 0%, #0f172a 100%) !important;
            color: #e2e8f0 !important;
            border-color: rgba(100, 116, 139, .45) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .35),
            inset 0 0 0 1px rgba(255, 255, 255, .06) !important;
        }

        .dark #prompt-input::placeholder {
            color: #64748b;
        }

        /* === SEND BUTTON (calm pill) === */
        #send-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            height: 44px;
            padding: 0 16px;
            border-radius: 9999px;
            border: 1px solid rgba(59, 130, 246, 0.35); /* blue-ish */
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); /* мягкий голубой */
            color: #0b1220;
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.10),
            inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            transition: transform .12s ease, box-shadow .2s ease, background .2s ease;
        }

        #send-btn svg {
            width: 16px;
            height: 16px;
            transition: transform .2s ease, opacity .2s ease;
        }

        #send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(2, 132, 199, 0.14),
            inset 0 0 0 1px rgba(255, 255, 255, 0.7);
            background: linear-gradient(135deg, #dff3ff 0%, #ffffff 100%);
        }

        #send-btn:active {
            transform: translateY(0);
        }

        /* состояние загрузки — блокируем и крутим иконку */
        #send-btn.is-loading {
            pointer-events: none;
            opacity: .85;
        }

        #send-btn.is-loading svg {
            animation: spin 1s linear infinite;
        }

        /* disabled */
        #send-btn:disabled {
            opacity: .55;
            cursor: not-allowed;
        }

        /* dark */
        .dark #send-btn {
            background: linear-gradient(135deg, #0f172a 0%, #0b1220 100%);
            color: #e2e8f0;
            border-color: rgba(100, 116, 139, .45);
            box-shadow: 0 4px 12px rgba(0, 0, 0, .35),
            inset 0 0 0 1px rgba(255, 255, 255, .06);
        }

        .dark #send-btn:hover {
            background: linear-gradient(135deg, #132033 0%, #0b1220 100%);
        }

        /* простая анимация вращения */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* =========================
   Chat List — full, lightweight
   ========================= */

        /* контейнер списка */
        #chat-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 2px;
            overflow: auto;
            max-height: calc(100% - 44px); /* чтобы шапка панели не перекрывалась */
        }

        /* тонкий скролл (в вебкит-браузерах) */
        #chat-list::-webkit-scrollbar {
            width: 6px;
        }

        #chat-list::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, .18);
            border-radius: 4px;
        }

        /* карточка чата */
        #chat-list .chat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px;
            background: #ffffff;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 10px;
            transition: background-color .12s ease, border-color .12s ease, transform .06s ease;
        }

        /* кнопка-тайтл (внутри .chat-item button.flex-1) */
        #chat-list .chat-item button.flex-1 {
            text-align: left;
            font-size: 12.5px;
            color: #0f172a; /* slate-900 */
            padding: 6px 8px;
            line-height: 1.35;
            border-radius: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* hover карточки — только фон/граница, без тяжёлых теней */
        #chat-list .chat-item:hover {
            background: #f8fafc; /* slate-50 */
            border-color: #d1d5db; /* gray-300 */
        }

        /* активная карточка — чёткая левая полоска + контрастная рамка */
        #chat-list .chat-item.active {
            background: #f0f7ff; /* очень мягкий голубой */
            border-color: #3b82f6; /* blue-500 */
            position: relative;
        }

        #chat-list .chat-item.active::before {
            content: "";
            position: absolute;
            left: -1px;
            top: 4px;
            bottom: 4px;
            width: 3px;
            border-radius: 2px;
            background: #3b82f6;
        }

        /* кнопка удаления справа — заметна, но ненавязчива */
        #chat-list .chat-item .delete-btn {
            opacity: .65;
            transition: opacity .12s ease, transform .06s ease;
        }

        #chat-list .chat-item .delete-btn:hover {
            opacity: 1;
            transform: scale(1.06);
        }

        /* лёгкое «нажатие» всей карточки */
        #chat-list .chat-item:active {
            transform: translateY(1px);
        }

        /* ── Дополнительно: бейдж «непрочитано» (если захочешь) ── */
        #chat-list .chat-item .chat-badge {
            margin-left: 4px;
            min-width: 18px;
            height: 18px;
            padding: 0 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 9px;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            background: #ef4444; /* red-500 */
        }

        /* ── Дополнительно: таймштамп справа (необязательно) ── */
        #chat-list .chat-item .chat-meta {
            margin-left: auto;
            padding: 0 6px;
            font-size: 11.5px;
            color: #64748b; /* slate-500 */
        }

        /* тёмная тема (если используешь .dark на html/body) */
        .dark #chat-list .chat-item {
            background: #0f172a; /* slate-900 */
            border-color: #1f2937; /* gray-800 */
        }

        .dark #chat-list .chat-item:hover {
            background: #111827; /* gray-900 */
            border-color: #374151; /* gray-700 */
        }

        .dark #chat-list .chat-item button.flex-1 {
            color: #e5e7eb;
        }

        .dark #chat-list .chat-item .chat-meta {
            color: #94a3b8;
        }

        .dark #chat-list .chat-item.active {
            background: #0b1a2b;
            border-color: #60a5fa; /* blue-400 */
        }

        .dark #chat-list .chat-item.active::before {
            background: #60a5fa;
        }

        /* уважение к reduce-motion — отключаем анимации */
        @media (prefers-reduced-motion: reduce) {
            #chat-list .chat-item,
            #chat-list .chat-item .delete-btn {
                transition: none !important;
            }
        }

        /* ==== Diagram Prompt: input + send ==== */
        #diagram-prompt {
            backdrop-filter: none; /* по-лёгкому, без blur */
            background: #ffffffcc; /* 80% белого */
            border-top: 1px solid #e5e7eb;
        }

        /* textarea — стеклянная карточка, но лёгкая */
        #diagram-prompt-input {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%) !important;
            border: 1px solid rgba(148, 163, 184, .45) !important; /* slate-400 */
            border-radius: 12px !important;
            padding: 10px 12px !important;
            color: #0f172a !important;
            min-height: 40px;
            max-height: 28vh; /* не раздуваем панель */
            overflow: auto; /* скролл внутри, без рефлоудов */
            box-shadow: 0 1px 4px rgba(15, 23, 42, .04),
            inset 0 0 0 1px rgba(255, 255, 255, .35) !important;
            transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
            resize: none; /* оставим автоскролл, без ручного ресайза */
        }

        #diagram-prompt-input::placeholder {
            color: #94a3b8;
        }

        #diagram-prompt-input:focus {
            outline: none;
            border-color: rgba(59, 130, 246, .55) !important; /* blue */
            box-shadow: 0 3px 10px rgba(59, 130, 246, .10),
            0 0 0 4px rgba(59, 130, 246, .12),
            inset 0 0 0 1px rgba(255, 255, 255, .45) !important;
            background: linear-gradient(135deg, #f9fbff 0%, #ffffff 100%) !important;
        }

        /* кнопка отправки — компактная «пилюля» */
        #diagram-prompt-send {
            height: 40px;
            padding: 0 14px;
            border-radius: 9999px;
            border: 1px solid rgba(59, 130, 246, .35);
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            color: #0b1220;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(2, 132, 199, .10),
            inset 0 0 0 1px rgba(255, 255, 255, .6);
            transition: transform .12s ease, box-shadow .2s ease, background .2s ease;
        }

        #diagram-prompt-send i {
            transition: transform .2s ease, opacity .2s ease;
        }

        #diagram-prompt-send:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(2, 132, 199, .14),
            inset 0 0 0 1px rgba(255, 255, 255, .7);
            background: linear-gradient(135deg, #dff3ff 0%, #ffffff 100%);
        }

        #diagram-prompt-send:active {
            transform: translateY(0);
        }

        #diagram-prompt-send:disabled {
            opacity: .55;
            cursor: not-allowed;
        }

        /* loading-состояние: крутим иконку */
        #diagram-prompt-send.is-loading {
            pointer-events: none;
            opacity: .9;
        }

        #diagram-prompt-send.is-loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* тёмная тема */
        .dark #diagram-prompt {
            background: #0f172acc;
            border-top-color: #1f2937;
        }

        .dark #diagram-prompt-input {
            background: linear-gradient(135deg, #0b1220 0%, #0f172a 100%) !important;
            color: #e2e8f0 !important;
            border-color: rgba(100, 116, 139, .45) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .35),
            inset 0 0 0 1px rgba(255, 255, 255, .06) !important;
        }

        .dark #diagram-prompt-input::placeholder {
            color: #64748b;
        }

        .dark #diagram-prompt-send {
            background: linear-gradient(135deg, #0f172a 0%, #0b1220 100%);
            color: #e2e8f0;
            border-color: rgba(100, 116, 139, .45);
            box-shadow: 0 4px 12px rgba(0, 0, 0, .35),
            inset 0 0 0 1px rgba(255, 255, 255, .06);
        }

        .dark #diagram-prompt-send:hover {
            background: linear-gradient(135deg, #132033 0%, #0b1220 100%);
        }

        /* уважение к reduce-motion */
        @media (prefers-reduced-motion: reduce) {
            #diagram-prompt-send,
            #diagram-prompt-input {
                transition: none !important;
            }

            #diagram-prompt-send.is-loading i {
                animation: none;
            }
        }

        /* ===== Diagram empty button ===== */
        #diagram-empty .diagram-empty-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 600;
            line-height: 1;
            color: #0b1220;
            background: linear-gradient(135deg, #e0f7ff 0%, #f5fbff 100%);
            border: 1px solid rgba(2, 132, 199, .35); /* cyan-600 @ 35% */
            box-shadow: 0 6px 14px rgba(2, 132, 199, .14),
            inset 0 0 0 1px rgba(255, 255, 255, .65);
            transition: transform .12s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
        }

        #diagram-empty .diagram-empty-btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(135deg, #daf4ff 0%, #ffffff 100%);
            box-shadow: 0 10px 20px rgba(2, 132, 199, .18),
            inset 0 0 0 1px rgba(255, 255, 255, .75);
            border-color: rgba(2, 132, 199, .5);
        }

        #diagram-empty .diagram-empty-btn:active {
            transform: translateY(0);
        }

        #diagram-empty .diagram-empty-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(2, 132, 199, .18),
            0 0 0 6px rgba(59, 130, 246, .12); /* лёгкий внешний фокус */
        }

        #diagram-empty .diagram-empty-btn i {
            font-size: 14px;
            opacity: .9;
            transition: transform .2s ease, opacity .2s ease;
        }

        #diagram-empty .diagram-empty-btn:hover i {
            transform: translateX(1px);
        }

        /* тёмная тема */
        .dark #diagram-empty .diagram-empty-btn {
            color: #e5e7eb;
            background: linear-gradient(135deg, #0f172a 0%, #0b1220 100%);
            border-color: rgba(148, 163, 184, .35);
            box-shadow: 0 6px 14px rgba(0, 0, 0, .35),
            inset 0 0 0 1px rgba(255, 255, 255, .06);
        }

        .dark #diagram-empty .diagram-empty-btn:hover {
            background: linear-gradient(135deg, #132033 0%, #0b1220 100%);
            border-color: rgba(148, 163, 184, .5);
        }

        /* уважение к reduce-motion */
        @media (prefers-reduced-motion: reduce) {
            #diagram-empty .diagram-empty-btn {
                transition: none !important;
            }

            #diagram-empty .diagram-empty-btn i {
                transition: none !important;
            }
        }

        /* ==============================
   Pane Diagrams — Calm Minimal
   ============================== */

        /* видимость панели контролируется радио — оставляем так */
        .pane-diagrams {
            display: none;
            padding: 4px;
        }

        #tab-diagrams:checked ~ .tab-content .pane-diagrams {
            display: block;
        }

        /* сам список — простой вертикальный поток */
        .pane-diagrams #diagram-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 2px;
            overflow: auto;
            max-height: calc(100% - 4px);
        }

        /* карточка-строка: ровная, без теней/градиентов */
        .pane-diagrams #diagram-list .chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #fff;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 12px;
            transition: background-color .12s ease, border-color .12s ease, transform .06s ease;
        }

        /* маленькая «иконка диаграммы» слева — чистый маркер без SVG */
        .pane-diagrams #diagram-list .chat-item::before {
            content: "";
            flex: 0 0 22px;
            height: 22px;
            border-radius: 6px;
            background: #eef6ff; /* очень мягкий синий */
            border: 1px solid #dbeafe; /* blue-100 */
        }

        /* заголовок кнопкой — две строки максимум */
        .pane-diagrams #diagram-list .chat-item button.flex-1 {
            text-align: left;
            font-size: 13px;
            line-height: 1.35;
            color: #0f172a; /* slate-900 */
            padding: 0;
            border-radius: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* максимум 2 строки */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ховер: едва заметное подсветление и чуток темнее граница */
        .pane-diagrams #diagram-list .chat-item:hover {
            background: #f8fafc; /* slate-50 */
            border-color: #d1d5db; /* gray-300 */
        }

        /* активная — строгая голубая рамка + тонкая левая полоса */
        .pane-diagrams #diagram-list .chat-item.active {
            background: #f6faff;
            border-color: #3b82f6; /* blue-500 */
            position: relative;
        }

        .pane-diagrams #diagram-list .chat-item.active::after {
            content: "";
            position: absolute;
            left: -1px;
            top: 8px;
            bottom: 8px;
            width: 2px;
            border-radius: 2px;
            background: #3b82f6;
        }

        /* кнопки действий справа (если есть) — деликатные */
        .pane-diagrams #diagram-list .chat-item .delete-btn {
            opacity: .65;
            transition: opacity .12s ease, transform .06s ease;
        }

        .pane-diagrams #diagram-list .chat-item .delete-btn:hover {
            opacity: 1;
            transform: scale(1.06);
        }

        /* пустое состояние из API: делаем аккуратно */
        .pane-diagrams #diagram-list .text-gray-500.text-xs {
            width: 100%;
            text-align: center;
            padding: 16px;
            color: #64748b; /* slate-500 */
            background: #f8fafc;
            border: 1px dashed #d1d5db;
            border-radius: 12px;
            font-size: 13px;
        }

        /* тонкий скролл */
        .pane-diagrams #diagram-list::-webkit-scrollbar {
            width: 6px;
        }

        .pane-diagrams #diagram-list::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, .18);
            border-radius: 4px;
        }

        /* тёмная тема — тот же минимализм */
        .dark .pane-diagrams #diagram-list .chat-item {
            background: #0f172a; /* slate-900 */
            border-color: #1f2937; /* gray-800 */
        }

        .dark .pane-diagrams #diagram-list .chat-item:hover {
            background: #111827;
            border-color: #374151; /* gray-700 */
        }

        .dark .pane-diagrams #diagram-list .chat-item::before {
            background: #0b1220;
            border-color: #1f2937;
        }

        .dark .pane-diagrams #diagram-list .chat-item button.flex-1 {
            color: #e5e7eb;
        }

        .dark .pane-diagrams #diagram-list .chat-item.active {
            background: #0b1a2b;
            border-color: #60a5fa; /* blue-400 */
        }

        .dark .pane-diagrams #diagram-list .chat-item.active::after {
            background: #60a5fa;
        }

        .dark .pane-diagrams #diagram-list .text-gray-500.text-xs {
            color: #94a3b8;
            background: #0b1220;
            border-color: #1f2937;
        }

        /* уважение к reduce-motion */
        @media (prefers-reduced-motion: reduce) {
            .pane-diagrams #diagram-list .chat-item,
            .pane-diagrams #diagram-list .chat-item .delete-btn {
                transition: none !important;
            }
        }

        /* ==============================
   Pane Diagrams — Compact Deluxe
   ============================== */

        .pane-diagrams {
            display: none;
            padding: 4px;
        }

        #tab-diagrams:checked ~ .tab-content .pane-diagrams {
            display: block;
        }

        /* список: очень плотный поток */
        .pane-diagrams #diagram-list {
            display: flex;
            flex-direction: column;
            gap: 6px; /* чуть воздуха */
            padding: 2px;
            overflow: auto;
            max-height: calc(100% - 4px);
        }

        /* строка-элемент: низкий, чёткий, без теней */
        .pane-diagrams #diagram-list .chat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px; /* компактно */
            background: #fff;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 10px;
            transition: background-color .12s ease, border-color .12s ease;
            min-height: 34px; /* низкий ряд */
        }

        /* маленький маркер слева */
        .pane-diagrams #diagram-list .chat-item::before {
            content: "";
            flex: 0 0 16px;
            height: 16px;
            border-radius: 4px;
            background: #eef6ff;
            border: 1px solid #dbeafe;
        }

        /* заголовок: 1 строка, обрезка, мелкий кегль */
        .pane-diagrams #diagram-list .chat-item button.flex-1 {
            text-align: left;
            padding: 0;
            font-size: 12.5px;
            line-height: 1.25;
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ховер: лёгчайший фон и граница */
        .pane-diagrams #diagram-list .chat-item:hover {
            background: #f8fafc; /* slate-50 */
            border-color: #d1d5db; /* gray-300 */
        }

        /* активная: строгая рамка + тонкая полоса */
        .pane-diagrams #diagram-list .chat-item.active {
            background: #f6faff;
            border-color: #3b82f6; /* blue-500 */
            position: relative;
        }

        .pane-diagrams #diagram-list .chat-item.active::after {
            content: "";
            position: absolute;
            left: -1px;
            top: 6px;
            bottom: 6px;
            width: 2px;
            border-radius: 2px;
            background: #3b82f6;
        }

        /* иконки действий справа — компактные */
        .pane-diagrams #diagram-list .chat-item .delete-btn {
            opacity: .65;
            transition: opacity .12s ease, transform .06s ease;
        }

        .pane-diagrams #diagram-list .chat-item .delete-btn:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        /* пустое состояние — тонкая карточка */
        .pane-diagrams #diagram-list .text-gray-500.text-xs {
            width: 100%;
            text-align: center;
            padding: 12px;
            color: #64748b;
            background: #f8fafc;
            border: 1px dashed #d1d5db;
            border-radius: 10px;
            font-size: 12.5px;
        }

        /* тонкий скролл */
        .pane-diagrams #diagram-list::-webkit-scrollbar {
            width: 6px;
        }

        .pane-diagrams #diagram-list::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, .18);
            border-radius: 4px;
        }

        /* тёмная тема */
        .dark .pane-diagrams #diagram-list .chat-item {
            background: #0f172a;
            border-color: #1f2937;
        }

        .dark .pane-diagrams #diagram-list .chat-item:hover {
            background: #111827;
            border-color: #374151;
        }

        .dark .pane-diagrams #diagram-list .chat-item::before {
            background: #0b1220;
            border-color: #1f2937;
        }

        .dark .pane-diagrams #diagram-list .chat-item button.flex-1 {
            color: #e5e7eb;
        }

        .dark .pane-diagrams #diagram-list .chat-item.active {
            background: #0b1a2b;
            border-color: #60a5fa;
        }

        .dark .pane-diagrams #diagram-list .chat-item.active::after {
            background: #60a5fa;
        }

        .dark .pane-diagrams #diagram-list .text-gray-500.text-xs {
            color: #94a3b8;
            background: #0b1220;
            border-color: #1f2937;
        }

        /* уважение к reduce-motion */
        @media (prefers-reduced-motion: reduce) {
            .pane-diagrams #diagram-list .chat-item,
            .pane-diagrams #diagram-list .chat-item .delete-btn {
                transition: none !important;
            }
        }

        #prompt-input {
            background: rgba(255, 255, 255, .9) !important; /* или оставь как у тебя */
            border: 1px solid rgba(148, 163, 184, .45) !important;
        }

        .dark #prompt-input {
            background: rgba(15, 23, 42, .85) !important;
        }

        .miro-overlay {
            background: radial-gradient(1200px 1200px at 50% 50%, rgba(0, 0, 0, .55), rgba(0, 0, 0, .4), rgba(0, 0, 0, .35));
        }

        .miro-shell {
            backdrop-filter: blur(14px) saturate(1.02);
        }

        .miro-btn {
            box-shadow: 0 6px 16px rgba(16, 185, 129, .08), inset 0 0 0 1px rgba(255, 255, 255, .6);
        }

        .miro-icon-btn {
            padding: 6px 8px;
            border-radius: 10px;
        }

        .miro-icon-btn:hover {
            background: rgba(255, 255, 255, .7);
        }


    </style>
</head>
<body class="min-h-screen flex flex-col p-2 md:p-4">

<!-- Верхняя панель для мобилки -->
<header class="flex items-center justify-between bg-white/70 backdrop-blur p-3 rounded-lg mb-2 shadow md:hidden">
    <button id="menu-left" class="text-emerald-600 text-xl"><i class="fas fa-bars"></i></button>
</header>

<!-- Основной контейнер -->
<div class="glass w-full flex-1 flex overflow-hidden">

    <!-- Левая панель (desktop) с вкладками -->
    <aside id="left-sidebar"
           class="hidden md:flex w-1/4 bg-white/60 backdrop-blur p-4 overflow-hidden scrollbar-thin flex-col">
        <div class="tabs">
            <!-- radios -->
            <input class="tab-radio" type="radio" name="sidebar-tabs" id="tab-chats" checked>
            <input class="tab-radio" type="radio" name="sidebar-tabs" id="tab-diagrams">
            <input class="tab-radio" type="radio" name="sidebar-tabs" id="tab-files">

            <!-- controls -->
            <div class="tab-controls mb-2">
                <label for="tab-chats"><i class="fa-regular fa-comments mr-1"></i> Чаты</label>
                <label for="tab-diagrams"><i class="fa-solid fa-diagram-project mr-1"></i> Диаграммы</label>
                <label for="tab-files"><i class="fa-regular fa-folder-open mr-1"></i> Файлы</label>
            </div>

            <!-- panes -->
            <div class="tab-content">
                <!-- CHATS -->
                <div class="tab-pane pane-chats">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold"></h2>
                        <button id="new-chat"
                                class="text-xs bg-green-400 text-white px-2 py-1 rounded hover:bg-green-500"
                                title="Новый чать"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                 class="bi bi-plus-lg" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                      d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
                            </svg>
                        </button>
                    </div>
                    <ul id="chat-list" class="space-y-2 text-sm text-gray-700"></ul>
                </div>

                <!-- DIAGRAMS -->
                <div class="tab-pane pane-diagrams">
                    <ul id="diagram-list" class="space-y-2 text-sm text-gray-700"></ul>
                </div>

                <!-- FILES -->
                <div class="tab-pane pane-files">
                    <div class="flex justify-between items-center mb-2">
                        <button id="connect-github-btn"
                                class="ml-1 text-xs bg-gray-800 text-white px-2 py-1 rounded hover:bg-gray-900 flex items-center gap-1">
                            <i class="fa-brands fa-github"></i> GitHub
                        </button>
                        <div class="mt-0">
                            <input type="file" id="file-upload-input"
                                   accept=".c,.cpp,.cs,.css,.doc,.docx,.go,.html,.java,.js,.json,.md,.pdf,.php,.pptx,.py,.rb,.sh,.tex,.ts,.txt"
                                   hidden/>
                            <button id="upload-file-btn"
                                    class="text-xs bg-green-400 text-white px-2 py-1 rounded hover:bg-green-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-plus-lg" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                          d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="files-list" class="space-y-2 text-sm text-gray-700"></div>
                </div>
            </div>
            <!-- FOOTER: кнопка Miro внизу сайдбара -->
            <div class="mt-auto pt-3 border-t border-black/5">
                <button id="open-miro-desktop"
                        class="w-full h-10 px-3 rounded-lg border border-sky-300 bg-gradient-to-br from-sky-100 to-white
                 text-sm font-semibold text-sky-900 shadow-sm hover:shadow inline-flex items-center justify-center gap-2">
                    <svg style="width: 8vh;" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg"
                         viewBox="0 0 703 258">
                        <defs>
                            <style>
                                .cls-1, .cls-2 {
                                    fill: #1c1c1e;
                                }

                                .cls-2 {
                                    fill-rule: evenodd;
                                }

                                .cls-3 {
                                    fill: #fd3;
                                }
                            </style>
                        </defs>
                        <g>
                            <path class="cls-1"
                                  d="M532.37,131.55v56.75h23.22v-53.26c0-23.74,32.28-23.74,32.28-23.74v-23.07s-9.01.42-16.14,2.03c-20.2,4.53-39.36,14.53-39.36,41.34v-.05Z"/>
                            <path class="cls-1"
                                  d="M357.16,87.03c9.06,0,20.36,5.1,26.5,14.11,6.35-8.17,16.87-13.75,29.83-13.95,16.45-.21,36.81,10.05,36.81,40.77v60.19h-23.22v-60.19c0-10.26-7.39-17.6-18.48-17.6s-18.49,7.34-18.49,17.6v60.19h-23.22v-60.19c0-10.26-7.39-17.6-18.48-17.6s-18.69,7.34-18.69,17.6v60.19h-24.42v-98.15h24.42v9.84c6.61-7.97,16.24-12.91,27.54-12.91l-.1.1Z"/>
                            <path class="cls-1" d="M503.79,91.3v96.95h-23.64v-96.95h23.64Z"/>
                            <path class="cls-1"
                                  d="M491.91,75.89c7.29,0,13.17-5.88,13.17-13.12s-5.88-13.12-13.17-13.12-13.17,5.88-13.17,13.12,5.88,13.12,13.17,13.12Z"/>
                            <path class="cls-1"
                                  d="M650.98,86.83c-28.64,0-51.81,23.07-51.81,51.55s23.22,51.55,51.81,51.55,51.81-23.07,51.81-51.55-23.22-51.55-51.81-51.55ZM650.98,166.75c-16.19,0-29.31-13.07-29.31-29.21s13.12-29.21,29.31-29.21,29.32,13.07,29.32,29.21-13.12,29.21-29.32,29.21Z"/>
                        </g>
                        <g>
                            <path class="cls-3"
                                  d="M.5,64.85C.5,29.45,29.24.7,64.64.7h128.3c35.41,0,64.15,28.74,64.15,64.15v128.29c0,35.41-28.74,64.15-64.15,64.15H64.64C29.24,257.3.5,228.55.5,193.15V64.85Z"/>
                            <path class="cls-2"
                                  d="M171.07,49.65h-23.27l19.42,34.1-42.7-34.1h-23.27l21.35,41.65-44.62-41.65h-23.27l23.27,53.06-23.27,106.11h23.27l44.62-113.66-21.35,113.66h23.27l42.7-121.27-19.42,121.27h23.27l42.7-132.62-42.7-26.5v-.05Z"/>
                        </g>
                    </svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Центральная область -->
    <main class="flex-1 flex flex-col">
        <!-- Сообщения -->
        <div id="chat-box" class="flex-1 overflow-y-auto px-4 md:px-6 py-4 space-y-3 scrollbar-thin chat-box-h">
            <div class="text-gray-400 text-sm text-center">✨ Новый чат</div>
        </div>

        <!-- Ввод -->
        <div class="p-3 bg-white/80 backdrop-blur">
            <div class="flex items-end gap-2">
                <textarea id="prompt-input" rows="1" placeholder="Введите сообщение..."
                          class="flex-1 resize-none bg-gray-100 p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-400 text-sm"></textarea>
                <button id="send-btn" class="bg-cyan-400 px-4 py-2 rounded-lg text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         class="bi bi-send" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- Offcanvas слева (мобильный) с вкладками -->
<div id="offcanvas-left" class="offcanvas offcanvas-left">
    <div class="p-4 border-b flex justify-between items-center">
        <button id="close-left"><i class="fas fa-times"></i></button>
    </div>

    <!-- radios -->
    <input class="tab-radio" type="radio" name="m-sidebar-tabs" id="mtab-chats" checked>
    <input class="tab-radio" type="radio" name="m-sidebar-tabs" id="mtab-diagrams">
    <input class="tab-radio" type="radio" name="m-sidebar-tabs" id="mtab-files">

    <!-- controls -->
    <div class="m-tab-controls p-3 pt-4 grid grid-cols-3 gap-2">
        <label for="mtab-chats" class="text-center text-xs px-2 py-2 rounded-lg border">Чаты</label>
        <label for="mtab-diagrams" class="text-center text-xs px-2 py-2 rounded-lg border">Диаграммы</label>
        <label for="mtab-files" class="text-center text-xs px-2 py-2 rounded-lg border">Файлы</label>
    </div>

    <!-- panes -->
    <div class="m-tab-content px-3 pb-4">
        <div class="m-pane-chats hidden">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-sm font-semibold"></h2>
                <button id="new-chat-mobile"
                        class="text-xs bg-green-400 text-white px-2 py-1 rounded hover:bg-green-500"
                        title="Новый чат">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         class="bi bi-plus-lg" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                              d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
                    </svg>
                </button>
            </div>
            <ul id="chat-list-mobile" class="space-y-2 text-sm text-gray-700"></ul>
        </div>
        <div class="m-pane-diagrams hidden">
            <ul id="diagram-list-mobile" class="space-y-2 text-sm text-gray-700"></ul>
        </div>
        <div class="m-pane-files hidden">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-sm font-semibold"></h2>
                <div>
                    <button id="upload-file-btn-mobile"
                            class="text-xs bg-green-400 text-white px-2 py-1 rounded hover:bg-green-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             class="bi bi-plus-lg" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- список файлов (как и было) -->
            <div id="files-list-mobile" class="space-y-2 text-sm text-gray-700"></div>
        </div>
    </div>

    <!-- FOOTER inside offcanvas (mobile) -->
    <div class="p-3 border-t">
        <button id="open-miro-desktop"
                class="w-full h-10 px-3 rounded-lg border border-sky-300 bg-gradient-to-br from-sky-100 to-white
                 text-sm font-semibold text-sky-900 shadow-sm hover:shadow inline-flex items-center justify-center gap-2"
                title="Открыть Miro">
            <i class="fa-brands fa-miro"></i>
            Открыть Miro
        </button>
    </div>
</div>

<!-- Лоадер -->
<div id="loader" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center space-y-4">
        <svg class="animate-spin h-10 w-10 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
        <span id="loader-text" class="text-gray-700 font-medium text-sm">Загрузка...</span>
    </div>
</div>

<div id="redirect-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
        <input id="redirect-filename" type="text" placeholder="Введите название файла..."
               class="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-emerald-400"/>
        <div class="flex justify-end gap-2">
            <button onclick="closeRedirectModal()" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm">
                Отмена
            </button>
            <button onclick="confirmRedirect()"
                    class="px-3 py-1 rounded bg-green-400 hover:bg-green-500 text-white text-sm">Подтвердить
            </button>
        </div>
    </div>
</div>

<!-- Успех -->
<div id="success-popup" class="fixed inset-0 flex items-center justify-center z-60 hidden">
    <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center space-y-3 animate-popup">
        <svg class="h-14 w-14 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
        <span id="success-text" class="text-gray-700 font-semibold text-base"></span>
    </div>
</div>

<div id="error-popup" class="fixed inset-0 flex items-center justify-center z-70 hidden">
    <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center space-y-3 animate-popup">
        <svg class="h-14 w-14 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        <span id="error-text" class="text-gray-700 font-semibold text-base"></span>
    </div>
</div>

<div id="diagram-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40 hidden">
    <div class="glass diagram-d relative rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        <!-- TOPBAR -->
        <div class="flex items-center justify-end px-4 py-3 border-b border-white/30 bg-white/40 backdrop-blur-md space-x-4 text-lg text-gray-600">
            <button id="view-diagram" class="hover:text-blue-500" title="Просмотр">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-diagram-2" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                          d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H11a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 5 7h2.5V6A1.5 1.5 0 0 1 6 4.5zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5zM3 11.5A1.5 1.5 0 0 1 4.5 10h1A1.5 1.5 0 0 1 7 11.5v1A1.5 1.5 0 0 1 5.5 14h-1A1.5 1.5 0 0 1 3 12.5zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm4.5.5a1.5 1.5 0 0 1 1.5-1.5h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 9 12.5zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z"/>
                </svg>
            </button>
            <button id="save-diagram" class="hover:text-blue-500 hidden" title="Сохранить диаграмму">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-box-arrow-down" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                          d="M3.5 10a.5.5 0 0 1-.5-.5v-8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 0 0 1h2A1.5 1.5 0 0 0 14 9.5v-8A1.5 1.5 0 0 0 12.5 0h-9A1.5 1.5 0 0 0 2 1.5v8A1.5 1.5 0 0 0 3.5 11h2a.5.5 0 0 0 0-1z"/>
                    <path fill-rule="evenodd"
                          d="M7.646 15.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 14.293V5.5a.5.5 0 0 0-1 0v8.793l-2.146-2.147a.5.5 0 0 0-.708.708z"/>
                </svg>
            </button>
            <button id="copy-code" class="hover:text-blue-500 hidden" title="Скопировать">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy"
                     viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                          d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
                </svg>
            </button>
            <button id="download-svg" class="hover:text-blue-500 hidden" title="Скачать SVG">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-filetype-svg" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                          d="M14 4.5V14a2 2 0 0 1-2 2v-1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM0 14.841a1.13 1.13 0 0 0 .401.823q.194.162.478.252.285.091.665.091.507 0 .858-.158.355-.158.54-.44a1.17 1.17 0 0 0 .187-.656q0-.336-.135-.56a1 1 0 0 0-.375-.357 2 2 0 0 0-.565-.21l-.621-.144a1 1 0 0 1-.405-.176.37.37 0 0 1-.143-.299q0-.234.184-.384.187-.152.513-.152.214 0 .37.068a.6.6 0 0 1 .245.181.56.56 0 0 1 .12.258h.75a1.1 1.1 0 0 0-.199-.566 1.2 1.2 0 0 0-.5-.41 1.8 1.8 0 0 0-.78-.152q-.44 0-.776.15-.337.149-.528.421-.19.273-.19.639 0 .302.123.524t.351.367q.229.143.54.213l.618.144q.31.073.462.193a.39.39 0 0 1 .153.326.5.5 0 0 1-.085.29.56.56 0 0 1-.256.193q-.167.07-.413.07-.176 0-.32-.04a.8.8 0 0 1-.248-.115.58.58 0 0 1-.255-.384zm4.575 1.09h.952l1.327-3.999h-.879l-.887 3.138H5.05l-.897-3.138h-.917zm5.483-3.293q.114.228.14.492h-.776a.8.8 0 0 0-.096-.249.7.7 0 0 0-.17-.19.7.7 0 0 0-.237-.126 1 1 0 0 0-.3-.044q-.427 0-.664.302-.235.3-.235.85v.497q0 .352.097.616a.9.9 0 0 0 .305.413.87.87 0 0 0 .518.146 1 1 0 0 0 .457-.097.67.67 0 0 0 .273-.263q.09-.164.09-.364v-.254h-.823v-.59h1.576v.798q0 .29-.096.55a1.3 1.3 0 0 1-.293.457 1.4 1.4 0 0 1-.495.314q-.296.111-.698.111a2 2 0 0 1-.752-.132 1.45 1.45 0 0 1-.534-.377 1.6 1.6 0 0 1-.319-.58 2.5 2.5 0 0 1-.105-.745v-.507q0-.54.199-.949.202-.406.583-.633.383-.228.926-.228.357 0 .635.1.282.1.48.275.2.176.314.407"/>
                </svg>
            </button>
            <button id="view-code" class="hover:text-blue-500 hidden" title="Редактировать код">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-code-slash" viewBox="0 0 16 16">
                    <path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0m6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0"/>
                </svg>
            </button>
            <button onclick="closeDiagram()" class="hover:text-red-500 text-xl" title="Закрыть">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x"
                     viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </button>
        </div>

        <!-- VIEW: диаграмма -->
        <div id="diagram-content"
             class="flex-1 relative p-0 overflow-hidden items-start justify-center bg-gradient-to-br from-gray-50 to-gray-100">
            <div class="text-gray-400 text-sm">Загрузка диаграммы...</div>
        </div>

        <!-- VIEW: редактор кода -->
        <textarea id="diagram-code"
                  class="hidden flex-1 min-h-0 w-full overflow-auto bg-gray-900 text-green-400 text-sm p-4 font-mono outline-none resize-none"></textarea>
        <!-- PROMPT BAR -->
        <div id="diagram-prompt" class="hidden shrink-0 border-t border-white/30 bg-white/50 backdrop-blur px-3 py-2">
            <div class="flex items-end gap-2">
                <textarea id="diagram-prompt-input" rows="1" placeholder="Напишите промпт для диаграммы…"
                          class="flex-1 resize-none bg-gray-100 p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-400 text-sm"></textarea>
                <button id="diagram-prompt-send" class="px-4 py-2 rounded-lg text-sm">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="save-diagram-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
        <input id="save-diagram-name" type="text" placeholder="Название диаграммы"
               class="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-emerald-400"/>
        <div class="flex justify-end gap-2">
            <button onclick="closeSaveDiagramModal()" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm">
                Отмена
            </button>
            <button onclick="confirmSaveDiagram()"
                    class="px-3 py-1 rounded bg-green-400 hover:bg-green-500 text-white text-sm">Сохранить
            </button>
        </div>
    </div>
</div>

<!-- GitHub Connect Modal -->
<div id="github-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white glass w-full max-w-xl rounded-2xl shadow-2xl p-5">
        <!-- Header -->
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-semibold">Привязать GitHub</h3>
            <button onclick="closeGitHubModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- STEP 1: ввод токена -->
        <div id="gh-step-token">
            <p class="text-sm text-gray-600 mb-2">
                Введите персональный токен GitHub<em>(repo:read)</em>.
            </p>
            <input id="github-token-input" type="password" autocomplete="off" placeholder="ghp_..."
                   class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-400 mb-3"/>
            <div class="flex items-center justify-end gap-2">
                <button class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm" onclick="closeGitHubModal()">
                    Отмена
                </button>
                <button class="px-3 py-1 rounded bg-green-400 hover:bg-green-500 text-white text-sm"
                        onclick="submitGitHubToken()">
                    Продолжить
                </button>
            </div>
        </div>

        <!-- STEP 2: список репозиториев -->
        <div id="gh-step-repos" class="hidden">
            <div class="flex items-center gap-2 mb-2">
                <input id="github-repo-search" type="text" placeholder="Поиск"
                       class="flex-1 border rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-400"/>
            </div>

            <div id="github-repo-list"
                 class="border rounded-lg max-h-80 overflow-auto p-2 text-sm bg-white/70 space-y-1">
                <!-- сюда отрендерятся radio-кнопки -->
            </div>

            <div class="flex items-center justify-between mt-3">
                <button class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm" onclick="backToTokenStep()">
                    Назад
                </button>
                <div class="flex items-center gap-2">
                    <button class="px-3 py-1 rounded bg-green-400 hover:bg-green-500 text-white text-sm"
                            onclick="confirmGitHubConnect()">
                        Привязать
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Miro: красивый оверлей с большим окном -->
<div id="miro-container"
     class="miro-overlay hidden fixed inset-0 z-[120] flex items-center justify-center">

    <div class="miro-shell glass relative rounded-2xl shadow-[0_20px_60px_rgba(0,0,0,.25)]
              bg-[linear-gradient(135deg,rgba(255,255,255,.92),rgba(245,250,255,.9))] border border-white/40 overflow-hidden"
         style="width:90vw;height:90vh;">

        <!-- Header -->
        <div class="miro-header flex items-center justify-between px-4 py-3
                bg-[linear-gradient(180deg,rgba(240,253,244,.85),rgba(255,255,255,.6))]
                border-b border-white/40 backdrop-blur">
            <div class="flex items-center gap-2">
                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-emerald-400 shadow"></span>
                <span class="font-semibold text-[15px] text-emerald-800">Miro</span>
            </div>

            <div class="flex items-center gap-2">
                <button id="miro-change-url"
                        class="miro-btn text-xs px-3 py-1.5 rounded-lg border border-emerald-300/60
                       bg-white/70 hover:bg-white active:scale-[.99] transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         class="bi bi-repeat" viewBox="0 0 16 16">
                        <path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/>
                    </svg>
                </button>
                <button id="miro-minimize"
                        class="miro-btn text-xs px-3 py-1.5 rounded-lg border border-sky-300/60
                       bg-white/70 hover:bg-white active:scale-[.99] transition"
                        title="Свернуть">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         class="bi bi-arrows-collapse" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                              d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8m7-8a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 4.293V.5A.5.5 0 0 1 8 0m-.5 11.707-1.146 1.147a.5.5 0 0 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 11.707V15.5a.5.5 0 0 1-1 0z"/>
                    </svg>
                </button>
                <button id="miro-close"
                        class="miro-icon-btn text-gray-600 hover:text-red-500 transition"
                        title="Закрыть">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x"
                         viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="miro-body relative w-full bg-white" style="height:calc(100% - 52px);">
            <div id="miro-iframe-holder"
                 class="absolute inset-0 flex items-center justify-center text-gray-500">
                <div class="text-center px-6">
                    <div class="text-3xl opacity-40 mb-3">
                        <i class="fa-brands fa-miro"></i>
                    </div>
                    <div class="text-sm text-slate-600">
                        Вставьте ссылку на доску Miro — окно откроется здесь, во весь размер.
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<!-- mermaid и zpp -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
<script src="/static/github.js"></script>
<script src="/static/miro.js"></script>
<script> mermaid.initialize({startOnLoad: false}); </script>

<script>
    // Offcanvas toggle
    $('#menu-left').click(() => $('#offcanvas-left').addClass('show'));
    $('#close-left, #chat-box').click(() => $('#offcanvas-left').removeClass('show'));

    // Синхронизация списков между desktop и mobile
    function syncLists() {
        $('#chat-list-mobile').html($('#chat-list').html());
        $('#files-list-mobile').html($('#files-list').html());
        $('#diagram-list-mobile').html($('#diagram-list').html());
    }

    setInterval(syncLists, 1000);

    let currentChatId = null;
    let availableFiles = [];

    let currentDiagramId = null;
    let currentDiagramCode = "";
    let isCodeView = false;
    let latestSVG = "";

    function ensureLivePreview() {
        let el = document.getElementById('live-preview');
        if (!el) {
            el = document.createElement('div');
            el.id = 'live-preview';
            el.innerHTML = `
              <div class="lp-header">
                <span></span>
                <button class="lp-close" title="Скрыть" aria-label="Скрыть превью" type="button">✕</button>
              </div>
              <div class="lp-body">
                <div class="lp-placeholder">
                  <span class="lp-dot"></span><span class="lp-dot"></span><span class="lp-dot"></span>
                  <span>Ожидаем ответ…</span>
                </div>
              </div>
              <div class="lp-footer">Предпросмотр AI ответ</div>
            `;
            document.body.appendChild(el);

            // close button
            el.querySelector('.lp-close').addEventListener('click', hideLivePreview);
        }
        return el;
    }

    function showLivePreview(initialText = '') {
        const el = ensureLivePreview();
        const body = el.querySelector('.lp-body');
        const placeholder = el.querySelector('.lp-placeholder');

        if (initialText && initialText.length) {
            body.textContent = initialText;
            el.classList.remove('empty');
        } else {
            // оставляем плейсхолдер
            if (!placeholder) {
                const ph = document.createElement('div');
                ph.className = 'lp-placeholder';
                ph.innerHTML = '<span class="lp-dot"></span><span class="lp-dot"></span><span class="lp-dot"></span><span>Готовлю ответ…</span>';
                body.innerHTML = '';
                body.appendChild(ph);
            }
            el.classList.add('empty');
        }
        el.classList.add('show');
    }

    function updateLivePreview(fullText = '') {
        const el = ensureLivePreview();
        const body = el.querySelector('.lp-body');
        if (!fullText) {
            el.classList.add('empty');
            if (!body.querySelector('.lp-placeholder')) {
                const ph = document.createElement('div');
                ph.className = 'lp-placeholder';
                ph.innerHTML = '<span class="lp-dot"></span><span class="lp-dot"></span><span class="lp-dot"></span><span>Готовлю ответ…</span>';
                body.innerHTML = '';
                body.appendChild(ph);
            }
        } else {
            el.classList.remove('empty');
            body.textContent = fullText; // важное: весь текст
            // авто-скролл вниз по мере роста
            body.scrollTop = body.scrollHeight;
        }
        el.classList.add('show');
    }

    function hideLivePreview() {
        const el = document.getElementById('live-preview');
        if (el) {
            el.classList.remove('show');
        }
    }


    function showLoader(text = 'Загрузка...') {
        $('#loader-text').text(text);
        $('#loader').removeClass('hidden');
    }

    function openSaveDiagramModal() {
        const dt = new Date();
        const stamp = dt.toLocaleString();
        $('#save-diagram-name').val(`Диаграмма ${stamp}`);
        $('#save-diagram-modal').removeClass('hidden');
        setTimeout(() => $('#save-diagram-name').focus(), 0);
    }

    function closeSaveDiagramModal() {
        $('#save-diagram-modal').addClass('hidden');
    }

    async function confirmSaveDiagram() {
        const name = ($('#save-diagram-name').val() || '').trim();
        if (!name) {
            showError('Введите название диаграммы');
            return;
        }
        if (!currentDiagramId) {
            showError('Нет кода диаграммы для сохранения');
            return;
        }

        try {
            showLoader('Сохраняю диаграмму...');
            const res = await fetch('/api/diagrams', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: name, ms_uuid: currentDiagramId})
            });
            if (!res.ok) {
                const t = await res.text().catch(() => '');
                throw new Error(t || `HTTP ${res.status}`);
            }
            closeSaveDiagramModal();
            hideLoader();
            showSuccess();
            loadDiagrams();
        } catch (e) {
            hideLoader();
            showError('Не удалось сохранить диаграмму');
            console.error('save diagram error:', e);
        }
    }

    $('#save-diagram').off().on('click', () => {
        const code = isCodeView ? ($('#diagram-code').val() || '') : (currentDiagramCode || '');
        if (!code) {
            showError('Нет кода диаграммы');
            return;
        }
        openSaveDiagramModal();
    });

    function loadDiagrams() {
        $.getJSON('/api/diagrams', function (data) {
            const list = $('#diagram-list');
            list.empty();
            const items = (data && data.items) ? data.items : [];
            if (items.length === 0) {
                list.append('<li class="text-gray-500 text-xs">Нет диаграмм</li>');
                return;
            }
            items.forEach(d => {
                const title = (d.title || 'Без названия');
                const safe = $('<div>').text(title.substring(0, 30) + (title.length > 30 ? '…' : '')).html();
                list.append(`
                <li class="chat-item group flex items-center justify-between">
                  <button class="flex-1 text-left px-1.5 py-1 truncate text-xs"
                          onclick="openDiagram('${d.ms_uuid}')">
                    ${safe}
                  </button>
                </li>`);
            });
        }).fail(() => {
            console.warn('Ошибка загрузки списка диаграмм');
        });
    }

    function hideLoader() {
        $('#loader').addClass('hidden');
    }

    function showSuccess() {
        $('#success-popup').removeClass('hidden').fadeIn(200);
        setTimeout(() => {
            $('#success-popup').fadeOut(300, () => $('#success-popup').addClass('hidden'));
        }, 1500);
    }

    function showError(text = 'Ошибка') {
        $('#error-text').text(text);
        $('#error-popup').removeClass('hidden').fadeIn(200);
        setTimeout(() => {
            $('#error-popup').fadeOut(300, () => $('#error-popup').addClass('hidden'));
        }, 2000);
    }

    function generateUUID() {
        return crypto.randomUUID();
    }

    function appendMessage(role, text, messageId = null) {
        const box = $('#chat-box');
        const id = messageId || 'msg-' + Date.now();
        const isUser = role === 'user';
        const bubbleClass = isUser ? 'user-bubble self-end' : 'assistant-bubble self-start';

        // ↓ Панель действий: снизу справа, только иконки
        const actionsHtml = !isUser ? `
        <div class="mt-1 flex justify-end">
          <div class="flex items-center gap-1.5
                      md:opacity-0 md:group-hover:opacity-100 transition-opacity duration-150">
            <button
              onclick="openDesign('${id}')"
              class="p-1.5 rounded-full bg-white/70 border border-gray-200 shadow-sm hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400"
              title="Дизайн" aria-label="Дизайн">
              <i class="fa-solid fa-wand-magic-sparkles text-xs"></i>
            </button>
            <button
              onclick="openDiagram('${id}')"
              class="p-1.5 rounded-full bg-white/70 border border-gray-200 shadow-sm hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400"
              title="Диаграмма" aria-label="Диаграмма">
              <i class="fas fa-project-diagram text-xs"></i>
            </button>
            <button
              onclick="openRedirectModal('${id}')"
              class="p-1.5 rounded-full bg-white/70 border border-gray-200 shadow-sm hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400"
              title="Сохранить" aria-label="Сохранить">
              <i class="fas fa-download text-xs"></i>
            </button>
          </div>
        </div>
      ` : '';

        const bubble = `
        <div class="flex ${isUser ? 'justify-end' : 'justify-start'} w-full mb-1">
          <div id="${id}"
               class="relative group max-w-[75%] px-3 py-2 text-sm shadow-sm ${bubbleClass}"
               ${!isUser ? 'ondblclick="editMessage(\'' + id + '\')"' : ''}>
            <div class="msg-text whitespace-pre-line">${$('<div>').text(text).html()}</div>
            ${actionsHtml}
          </div>
        </div>`;

        box.append(bubble);
        box.scrollTop(box[0].scrollHeight);
    }


    function editMessage(id) {
        const el = $('#' + id).find('.msg-text');
        el.attr('contenteditable', 'true')
            .addClass('outline-none rounded-md p-2 bg-white')
            .focus();

        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(el[0]);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);

        el.off('blur').on('blur', function () {
            saveMessage(id);
        });
        el.off('keydown').on('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveMessage(id);
                el.blur();
            }
        });
    }

    function saveMessage(id) {
        const el = $('#' + id).find('.msg-text');
        const newText = el.text().trim();
        el.removeAttr('contenteditable').removeClass('border border-emerald-400 rounded-md p-2 bg-white');

        fetch(`/api/chats/${currentChatId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'edit_message',
                messageId: id,
                text: newText
            })
        })
            .then(r => r.json())
            .then(res => {
                if (res._success) {
                    showSuccess();
                } else {
                    showError('');
                }
            })
            .catch(() => {
                showError('Ошибка');
            });
    }

    function redirectMessage(id, filename) {
        const el = $('#' + id).find('.msg-text');
        const text = el.text().trim();
        showLoader();
        fetch(`/api/chats/${currentChatId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({messageId: id, action: 'redirect', text, filename})
        })
            .then(r => r.json())
            .then(() => {
                showSuccess();
                hideLoader();
                loadFiles();
            })
            .catch(err => {
                alert('Ошибка перенаправления: ' + err.message);
                hideLoader();
            });
    }

    function loadChatHistory() {
        showLoader('Загрузка истории...');
        $.getJSON('/api/chats', function (data) {
            const chatList = $('#chat-list');
            chatList.empty();
            const items = data.items;
            if (items.length === 0) {
                chatList.append('<li class="text-gray-500 text-center py-1 text-xs">Нет истории чатов</li>');
            } else {
                items.forEach(chat => {
                    chatList.append(`
                        <li class="chat-item group flex items-center justify-between">
                            <button class="flex-1 text-left px-1.5 py-1 truncate text-xs"
                                    onclick="viewChat('${chat._id}', this)">
                                ${$('<div>').text(chat.title.substring(0, 25) + (chat.title.length > 25 ? '...' : '')).html()}
                            </button>
                            <button
                                class="delete-btn p-0.5 text-gray-400 hover:text-red-500 group-hover:visible"
                                onclick="deleteChat('${chat._id}', this)"
                            >
                                <i class="fas fa-trash-alt text-[10px]"></i>
                            </button>
                        </li>`);
                });
            }
            hideLoader();
        }).fail(() => {
            alert('Ошибка загрузки истории');
            hideLoader();
        });
    }

    function loadFiles() {
        showLoader('Загрузка файлов...');
        $.getJSON('/api/files', function (data) {
            const filesList = $('#files-list');
            filesList.empty();
            availableFiles = data.items || [];
            if (availableFiles.length === 0) {
                filesList.append('<div class="text-gray-500 text-center py-1 text-xs">Нет файлов</div>');
            } else {
                availableFiles.forEach(file => {
                    filesList.append(`
                        <div class="file-item flex items-center justify-between p-1.5 bg-white rounded border text-xs">
                            <a target="_blank" href="/api/files/${file._id}/download" class="truncate flex-1 text-emerald-600 hover:underline">
                                ${$('<div>').text(file.title.substring(0, 20) + (file.title.length > 20 ? '...' : '')).html()}
                            </a>
                            <div class="flex space-x-1">
                                <button onclick="deleteFile('${file._id}', this)" class="text-gray-500 hover:text-red-500 p-0.5">
                                    <i class="fas fa-trash-alt text-[10px]"></i>
                                </button>
                            </div>
                        </div>`);
                });
            }
            hideLoader();
        }).fail(() => {
            alert('Ошибка загрузки файлов');
            hideLoader();
        });
    }

    function deleteFile(fileId, button) {
        if (!confirm('Удалить этот файл?')) return;
        $(button).prop('disabled', true).html('<i class="fas fa-spinner fa-spin text-[10px]"></i>');
        $.ajax({
            url: `/api/files/${fileId}`,
            type: 'DELETE',
            success: function (response) {
                if (response._success) {
                    loadFiles();
                } else {
                    alert('Ошибка: ' + (response.message || 'Не удалось удалить файл'));
                    $(button).prop('disabled', false).html('<i class="fas fa-trash-alt text-[10px]"></i>');
                }
            },
            error: function () {
                alert('Ошибка соединения');
                $(button).prop('disabled', false).html('<i class="fas fa-trash-alt text-[10px]"></i>');
            }
        });
    }

    function deleteChat(chatId, button) {
        if (!confirm('Удалить этот чат?')) return;
        $(button).prop('disabled', true).html('<i class="fas fa-spinner fa-spin text-[10px]"></i>');
        $.ajax({
            url: `/api/chats/${chatId}`,
            type: 'DELETE',
            success: function (response) {
                if (response._success) {
                    if (currentChatId === chatId) {
                        $('#new-chat').click();
                    }
                    loadChatHistory();
                } else {
                    alert('Ошибка: ' + (response.message || 'Не удалось удалить чат'));
                    $(button).prop('disabled', false).html('<i class="fas fa-trash-alt text-[10px]"></i>');
                }
            },
            error: function () {
                alert('Ошибка соединения');
                $(button).prop('disabled', false).html('<i class="fas fa-trash-alt text-[10px]"></i>');
            }
        });
    }

    function viewChat(chatId, el) {
        showLoader('Загрузка чата...');
        $('#offcanvas-left').removeClass('show');
        $.getJSON(`/api/chats/${chatId}`, function (chat) {
            const item = chat.content;
            const box = $('#chat-box');
            box.empty();
            item.forEach(item => {
                if (item.role === 'user') appendMessage('user', item.text);
                if (item.role === 'assistant') appendMessage('assistant', item.text, item.ms_uuid);
            });
            currentChatId = chatId;
            $('#chat-list .chat-item').removeClass('active');
            if (el) $(el).closest('.chat-item').addClass('active');
            hideLoader();
        }).fail(() => {
            alert('Ошибка загрузки чата');
            hideLoader();
        });
    }

    function uploadFiles(files) {
        if (files.length === 0) return;
        showLoader('Загрузка файлов...');
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }
        $.ajax({
            url: '/api/files',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response._success) {
                    loadFiles();
                } else {
                    alert('Ошибка: ' + (response.message || 'Не удалось загрузить файлы'));
                }
                hideLoader();
            },
            error: function () {
                alert('Ошибка соединения при загрузке');
                hideLoader();
            }
        });
    }

    async function openDiagram(id) {
        currentDiagramId = id;
        isCodeView = false;
        $('#diagram-modal').removeClass('hidden');
        $('#diagram-prompt').addClass('hidden');
        $('#diagram-content').removeClass('hidden').html('<div class="text-gray-500 text-center mt-10">Загрузка...</div>');
        $('#diagram-code').addClass('hidden');

        try {
            const res = await fetch(`/api/diagrams/${id}`);
            const data = await res.json();
            if (!data || !data.code) {
                $('#diagram-content')
                    .removeClass('p-6')
                    .addClass('p-0 relative')
                    .empty()
                    .append(`
                        <div id="diagram-empty" class="absolute inset-0 flex items-center justify-center">
                          <button onclick="generateDiagram('${id}')" class="diagram-empty-btn" type="button">
                            <i class="fas fa-magic"></i>
                            <span>Генерировать диаграмму</span>
                          </button>
                        </div>
                      `);
                return;
            }
            currentDiagramCode = data.code;
            await renderDiagram(currentDiagramCode);
            $('#diagram-prompt, #view-code, #download-svg, #copy-code, #save-diagram').removeClass('hidden');
            bindToolbar();
        } catch (err) {
            $('#diagram-content').html('<div class="text-red-500">Ошибка: ' + err.message + '</div>');
        }
    }

    async function sendDiagramPrompt() {
        const $inp = $('#diagram-prompt-input');
        const prompt = ($inp.val() || '').trim();
        if (!prompt) {
            showError('Введите промпт');
            return;
        }
        if (!currentDiagramId) {
            showError('Нет активной диаграммы');
            return;
        }
        try {
            showLoader('Обновляю диаграмму...');
            const res = await fetch(`/api/diagrams/${currentDiagramId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({prompt, action: 're-generate'})
            });
            if (!res.ok) {
                const t = await res.text().catch(() => '');
                throw new Error(t || `HTTP ${res.status}`);
            }
            $inp.val('');
            hideLoader();
            openDiagram(currentDiagramId);
            showSuccess();
        } catch (err) {
            hideLoader();
            showError('Не удалось отправить промпт');
            console.error('sendDiagramPrompt error:', err);
        }
    }

    function bindToolbar() {
        $('#copy-code').off().on('click', () => {
            navigator.clipboard.writeText(currentDiagramCode);
            showSuccess();
        });
        $('#download-svg').off().on('click', () => {
            if (!latestSVG) return;
            const blob = new Blob([latestSVG], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagram.svg';
            a.click();
            URL.revokeObjectURL(url);
        });
        $('#view-code').off().on('click', async () => {
            if (diagramPanZoom) {
                diagramPanZoom.destroy();
                diagramPanZoom = null;
            }
            $(window).off('resize.diagram');
            $('#diagram-content').addClass('hidden');
            $('#diagram-code').removeClass('hidden').val(currentDiagramCode).focus();
            isCodeView = true;
        });

        $('#view-diagram').off().on('click', async () => {
            $('#diagram-content').removeClass('hidden');
            await renderDiagram(currentDiagramCode);
            isCodeView = false;
        });
    }

    let diagramPanZoom = null;

    async function renderDiagram(code) {
        try {
            const {svg} = await mermaid.render('generatedDiagram', code);
            latestSVG = svg;
            const $dc = $('#diagram-content');
            $dc.find('#diagram-empty').remove();
            $dc.html('<div class="svg-stage"></div>');
            const $stage = $dc.find('.svg-stage');
            $stage.html(svg);

            const svgEl = $stage.find('svg').get(0);
            if (svgEl) {
                svgEl.removeAttribute('width');
                svgEl.removeAttribute('height');
                svgEl.style.width = '100%';
                svgEl.style.height = '100%';
                svgEl.style.overflow = 'visible';
                if (!svgEl.getAttribute('viewBox')) {
                    const bb = svgEl.getBBox ? svgEl.getBBox() : null;
                    if (bb) svgEl.setAttribute('viewBox', `${bb.x} ${bb.y} ${bb.width} ${bb.height}`);
                }
                svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');
            }

            if (diagramPanZoom) {
                diagramPanZoom.destroy();
                diagramPanZoom = null;
            }
            diagramPanZoom = svgPanZoom(svgEl, {
                panEnabled: true, zoomEnabled: true, controlIconsEnabled: false,
                fit: true, center: true, contain: true,
                minZoom: 0.2, maxZoom: 10, zoomScaleSensitivity: 0.2,
                dblClickZoomEnabled: true, mouseWheelZoomEnabled: true
            });
            diagramPanZoom.resize();
            diagramPanZoom.fit();
            diagramPanZoom.center();
            $(window).off('resize.diagram').on('resize.diagram', () => {
                if (!diagramPanZoom) return;
                diagramPanZoom.resize();
                diagramPanZoom.fit();
                diagramPanZoom.center();
            });

            $('#diagram-code').addClass('hidden');
            isCodeView = false;
            $('#diagram-prompt').removeClass('hidden');
        } catch (err) {
            console.log(err);
            $('#diagram-content').html('<div class="text-red-500">Ошибка рендера</div>');
        }
    }

    function closeDiagram() {
        if (diagramPanZoom) {
            diagramPanZoom.destroy();
            diagramPanZoom = null;
        }
        $(window).off('resize.diagram');
        $('#diagram-content').removeClass('hidden').empty();
        $('#view-code, #download-svg, #copy-code, #save-diagram, #diagram-modal, #diagram-code, #diagram-prompt, #view-diagram').addClass('hidden');
        isCodeView = false;
        latestSVG = "";
    }

    // Плейсхолдер в модалке, если дизайна ещё нет
    function showDesignPlaceholder(messageId) {
        ensureDesignCanvas();
        $('#design-modal-content').html(`
        <div class="flex flex-col items-center justify-center py-6 text-center">
          <div class="text-gray-600 mb-3">Для этого сообщения дизайн ещё не создан.</div>
          <button id="design-generate-btn"
                  class="px-4 py-2 rounded-lg">
            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Сгенерировать
          </button>
        </div>
      `);
        $('#design-modal').removeClass('hidden');

        // Привязываем клик к генерации
        $('#design-generate-btn').off('click').on('click', () => generateDesign(messageId));
    }

    // Открытие дизайна: сначала GET /api/designs/${messageId}
    async function openDesign(messageId) {
        try {
            showLoader('Открываю дизайн...');
            const res = await fetch(`/api/designs/${messageId}`, {method: 'GET'});
            const data = await res.json().catch(() => ({}));
            hideLoader();

            if (data && data.content) {
                // Если есть готовый контент — показываем сразу
                showDesignCanvas(data.content);
            } else {
                // Иначе — плейсхолдер с кнопкой "Сгенерировать"
                showDesignPlaceholder(messageId);
            }
        } catch (e) {
            hideLoader();
            showError('Ошибка открытия дизайна: ' + e.message);
        }
    }


    async function generateDiagram(id) {
        showLoader('Генерация...');
        try {
            await fetch(`/api/diagrams/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({chat_id: currentChatId})
            })
                .then(r => r.json())
                .then(() => {
                    hideLoader();
                    openDiagram(id);
                })
                .catch(() => {
                    showError('Ошибка генерации');
                    hideLoader();
                });
        } catch (err) {
            hideLoader();
            showError('Ошибка генерации');
        }
    }

    // Создаём (один раз) отдельный "canvas" блок под чат, чтобы показывать результат дизайна
    // ЦЕНТРИРОВАННЫЙ МОДАЛ ДЛЯ ДИЗАЙНА
    function ensureDesignCanvas() {
        let $m = $('#design-modal');
        if ($m.length === 0) {
            $('body').append(`
      <div id="design-modal"
           class="fixed inset-0 bg-black/50 flex items-center justify-center hidden"
           style="z-index:60">
        <div class="glass bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-5 relative"
             style="max-height:85vh; overflow:auto;">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-semibold">Дизайн</h3>
            <div class="flex gap-2">
              <button id="design-copy" class="text-gray-500 hover:text-emerald-600" title="Скопировать">
                <i class="fa-regular fa-copy"></i>
              </button>
              <button id="design-close" class="text-gray-500 hover:text-red-500" title="Закрыть">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>
          <div id="design-modal-content" class="text-sm whitespace-pre-wrap"></div>
        </div>
      </div>
    `);

            // Обработчики — один раз
            $(document).on('click', '#design-close', () => $('#design-modal').addClass('hidden'));
            $(document).on('click', '#design-modal', (e) => {
                if (e.target.id === 'design-modal') $('#design-modal').addClass('hidden'); // клик по подложке
            });
            $(document).on('click', '#design-copy', () => {
                const t = $('#design-modal-content').text();
                navigator.clipboard.writeText(t);
                showSuccess();
            });
            $(document).on('keydown', (e) => {
                if (!$('#design-modal').hasClass('hidden') && e.key === 'Escape') {
                    $('#design-modal').addClass('hidden');
                }
            });

            $m = $('#design-modal');
        }
        return $m;
    }

    function showDesignCanvas(message) {
        ensureDesignCanvas();
        // .text() — безопасно. Если сервер гарантирует безопасный HTML — смените на .html(message).
        $('#design-modal-content').text(message || '');
        $('#design-modal').removeClass('hidden');
    }


    // Основная функция для кнопки "Сгенерировать дизайн"
    async function generateDesign(messageId) {
        try {
            showLoader('Генерирую дизайн...');
            const response = await fetch(`/api/designs/${messageId}`, {
                method: 'POST',
                body: JSON.stringify({chat_id: currentChatId})
            });

            if (!response.ok) throw new Error(`Ошибка ${response.status}`);
            if (!response.body) throw new Error('Поток не поддерживается');

            const reader = response.body.getReader();

            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
            }
            hideLoader();
            await openDesign(messageId);
        } catch (error) {
            hideLoader();
            showError('Ошибка: ' + e.message);
        }
    }


    $('#diagram-code').on('input', async function () {
        currentDiagramCode = $(this).val();
        try {
            await fetch(`/api/diagrams/${currentDiagramId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'edit-code', code: currentDiagramCode})
            });
        } catch (err) {
            console.error('Ошибка сохранения', err);
        }
    });

    $(document).ready(function () {
        loadChatHistory();
        loadFiles();
        loadDiagrams();

        $('#prompt-input').on('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                $('#send-btn').click();
            }
        });

        $('#prompt-input').off('input').on('input', function () {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        $('#file-upload-input').on('change', function () {
            const files = Array.from(this.files);
            if (files.length > 0) {
                uploadFiles(files);
                $(this).val('');
            }
        });

        $(document).on('click', '#diagram-prompt-send', function () {
            sendDiagramPrompt();
        });

        $('#send-btn').click(async function () {
            const prompt = $('#prompt-input').val().trim();
            if (!prompt) return alert('Введите сообщение');
            const $btn = $('#send-btn');
            $btn.prop('disabled', true).addClass('is-loading');
            let ms_uuid = generateUUID();

            appendMessage('user', prompt);
            showLoader('Думаю...');

            try {
                const response = await fetch('/api/response', {
                    method: 'POST',
                    body: JSON.stringify({prompt, chat_id: currentChatId, ms_uuid})
                });

                if (!response.ok) throw new Error(`Ошибка ${response.status}`);
                if (!response.body) throw new Error('Поток не поддерживается');
                showLivePreview('');
                hideLoader();
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let assistantMessage = '';

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, {stream: true}).replace(/\r/g, '');

                    let nl;
                    while ((nl = buffer.indexOf('\n')) !== -1) {
                        const line = buffer.slice(0, nl).trim();
                        buffer = buffer.slice(nl + 1);

                        if (!line) continue;
                        if (line === '[DONE]') {
                            appendMessage('assistant', assistantMessage, ms_uuid);
                            $('#prompt-input').val('').css('height', 'auto');
                            $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                            hideLivePreview();
                            hideLoader();
                            loadChatHistory();
                            return;
                        }

                        const parsed = JSON.parse(line);
                        assistantMessage += parsed.text ?? '';
                        currentChatId = parsed.chat_id ?? currentChatId;
                        updateLivePreview(assistantMessage);

                        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    }
                }

                if (buffer.trim()) {
                    const parsed = JSON.parse(buffer);
                    assistantMessage += parsed.text ?? '';
                    currentChatId = parsed.chat_id ?? currentChatId;
                    updateLivePreview(assistantMessage);
                }

                appendMessage('assistant', assistantMessage, ms_uuid);

            } catch (error) {
                appendMessage('assistant', `Ошибка: ${error.message}`);
            } finally {
                hideLoader();
                loadChatHistory();
                hideLivePreview();
                $('#send-btn').prop('disabled', false).removeClass('is-loading');
            }
        });

        $('#new-chat').click(function () {
            $('#attached-files').empty();
            $('#chat-box').html('<div class="text-gray-400 text-sm text-center">✨ Новый чат</div>');
            currentChatId = null;
            loadFiles();
            $('#chat-list .chat-item').removeClass('active');
            $('#chat-list-mobile .chat-item').removeClass('active');
        });

        $('#upload-file-btn, #upload-file-btn-mobile').click(() => $('#file-upload-input').click());

        $('#new-chat-mobile').click(() => {
            $('#new-chat').click();
            $('#offcanvas-left').removeClass('show'); // по желанию — закрыть меню
        });
    });

    let redirectMessageId = null;

    function openRedirectModal(id) {
        redirectMessageId = id;
        $('#redirect-filename').val('');
        $('#redirect-modal').removeClass('hidden');
        $('#redirect-filename').focus();
    }

    function closeRedirectModal() {
        $('#redirect-modal').addClass('hidden');
        redirectMessageId = null;
    }

    function confirmRedirect() {
        const filename = $('#redirect-filename').val().trim();
        if (!filename) {
            alert('Введите название файла');
            return;
        }
        $('#redirect-modal').addClass('hidden');
        redirectMessage(redirectMessageId, filename);
        redirectMessageId = null;
    }
</script>

</body>
</html>
