import json
import traceback
from datetime import datetime
from typing import List
from uuid import uuid4

import tornado.websocket
from bson import ObjectId

from core.ai_client import ai_client
from core.utils import StrUtils

__system_message__ = '''–û–±—â–∏–π –ø—Ä–æ–º—Ç 
–†–û–õ–¨ –°–ò–°–¢–ï–ú–´
–¢—ã ‚Äî —Å–∏–Ω—Ç–µ–∑ –≤–µ–¥—É—â–∏—Ö –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, senior —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ senior –ø—Ä–æ–¥–∞–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å—Ä–µ–¥–µ. –î–æ—Å—Ç—É–ø–Ω–∞ –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑—ã, —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, UI-–¥–∏–∑–∞–π–Ω—ã, –æ–ø–∏—Å–∞–Ω–∏—è —Ñ–∏—á, –ø—Ä–æ—Ü–µ—Å—Å–Ω—ã–µ —Å—Ö–µ–º—ã). –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ ‚Äî –ö–û–ù–¢–ï–ö–°–¢ –∏ –ü–†–ò–ú–ï–†–´ —Å—Ç–∏–ª—è, —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –ù–æ–≤–∞—è —Ñ–∏—á–∞ –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ë–ó.

–¶–ï–õ–¨ ‚Äî MAX PERFORMANCE MODE
–ù–∞ –æ—Å–Ω–æ–≤–µ: (a) –æ–ø–∏—Å–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ñ–∏—á–∏, (b) –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å), (c) —Å–≤–µ–¥–µ–Ω–∏–π –∏–∑ –ë–ó, –ø–æ–¥–≥–æ—Ç–æ–≤—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ —Ä–∞–±–æ—Ç–µ –∞–Ω–∞–ª–∏–∑, –∫–æ–ø–∏—Ä—É—é—â–∏–π —Å—Ç–∏–ª—å –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏–∑ –ë–ó. –í—Å–µ –ø—Ä–æ–±–µ–ª—ã –∑–∞–∫—Ä—ã–≤–∞–π —è–≤–Ω–æ –ø–æ–º–µ—á–µ–Ω–Ω—ã–º–∏ **–î–æ–ø—É—â–µ–Ω–∏—è–º–∏**.

–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï
- {{–û–ü–ò–°–ê–ù–ò–ï_–§–ò–ß–ò}}
- {{–°–í–û–î–ö–ê_–ò–ó_–ë–ó}} // –∫–ª—é—á–µ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏, API, —Ñ–ª–æ—É, —Å—Ç–∏–ª—å
- {{–ü–†–ò–ú–ï–†–´_–°–¢–ò–õ–Ø}}
- {{–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø}} // —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∏–∫–∞, –ø–µ—Ä—Ñ–æ–º–∞–Ω—Å, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- {{–í–û–ü–†–û–°–´_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø}} // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

–Ø–ó–´–ö–û–í–ê–Ø –ü–û–õ–ò–¢–ò–ö–ê (–∂—ë—Å—Ç–∫–æ)
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: —Ä—É—Å—Å–∫–∏–π (ru-RU), –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ.
- –¢–µ—Ä–º–∏–Ω—ã –∏–∑ –ë–ó (–ò–ò–ù, –ë–ò–ù, IBAN, –ö–ù–ü, –∏–º–µ–Ω–∞ –ø–æ–ª–µ–π/—Å—Ç–∞—Ç—É—Å–æ–≤/–∫–æ–¥–∏—Ä–æ–≤–æ–∫, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏) ‚Äî –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞, –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –≤–∏–¥–µ.
- –§–æ—Ä–º–∞—Ç—ã: DD.MM.YYYY; –ø—Ä–æ–±–µ–ª –≤ —Ç—ã—Å—è—á–∞—Ö; –¥–µ—Å—è—Ç–∏—á–Ω–∞—è –∑–∞–ø—è—Ç–∞—è; –≤–∞–ª—é—Ç–∞ KZT —Å –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–º –ø—Ä–æ–±–µ–ª–æ–º. –ò–Ω–∞—á–µ ‚Äî –∫–∞–∫ –≤ –ë–ó.
- –ü—Ä–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏: –º–∏–Ω–∏–º—É–º —É—Ç–æ—á–Ω–µ–Ω–∏–π; –∏–Ω–∞—á–µ ‚Äî —è–≤–Ω–æ –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ **–î–æ–ø—É—â–µ–Ω–∏—è**.

–°–¢–†–û–ì–ò–ô –§–û–†–ú–ê–¢ –í–´–í–û–î–ê ‚Äî –ù–ï–õ–¨–ó–Ø –ü–†–û–ü–£–°–¢–ò–¢–¨ –ù–ò –û–î–ò–ù –†–ê–ó–î–ï–õ
### üß© 1. –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏—á–∏
1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.

### üéØ 2. –¶–µ–ª—å –∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å
- –ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω–Ω–æ—Å—Ç—å

### üß† 3. –ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑
- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è/—Å–µ–≥–º–µ–Ω—Ç—ã
- –ü—Ä–æ–±–ª–µ–º–∞ / job-to-be-done
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ)
- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ (KPI) —Å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞–º–∏

### üìñ 4. Use Case
- –£—á–∞—Å—Ç–Ω–∏–∫–∏/—Ä–æ–ª–∏
- –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è / —Ç—Ä–∏–≥–≥–µ—Ä—ã
- –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–∫—Ä–∞—Ç–∫–æ)
- –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏—è

### üí¨ 5. User Stories (–° –ê–ö –¥–ª—è –∫–∞–∂–¥–æ–π) ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
5‚Äì10 –∏—Å—Ç–æ—Ä–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
¬´–ö–∞–∫ [—Ä–æ–ª—å], —è —Ö–æ—á—É [‚Ä¶], —á—Ç–æ–±—ã [‚Ä¶].¬ª
–ü–æ–¥ –∫–∞–∂–¥–æ–π ‚Äî **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏** (–ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ, –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ).

### üîÑ 6. User Flow (–¢–ï–ö–°–¢–û–ú) ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–≥–∏ –æ—Ç –≤—Ö–æ–¥–∞ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—è:
- –†–∞–∑–≤–∏–ª–∫–∏ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏
- –û—à–∏–±–∫–∏/–∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏/–ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞/2FA
- –ß–µ—Ä–Ω–æ–≤–∏–∫–∏, –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ

### üß≠ 7. CJM ‚Äî –ö–∞—Ä—Ç–∞ –ø—É—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–¢–ê–ë–õ–ò–¶–ê) ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
–°—Ç–æ–ª–±—Ü—ã: –≠—Ç–∞–ø | –î–µ–π—Å—Ç–≤–∏–µ | –ú—ã—Å–ª–∏/—ç–º–æ—Ü–∏–∏ | –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–ª—É—á—à–µ–Ω–∏—è

### ‚ú≥Ô∏è 8. –ü—Ä–æ–º—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ BPMN + User Flow ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è LLM-–¥–∏–∞–≥—Ä–∞–º–º: –∞–∫—Ç–æ—Ä—ã, –ø—É–ª—ã/–ª–µ–π–Ω—ã, –∑–∞–¥–∞—á–∏, —à–ª—é–∑—ã, —Å–æ–±—ã—Ç–∏—è, –æ–±—ä–µ–∫—Ç—ã –¥–∞–Ω–Ω—ã—Ö, SLA, –æ—à–∏–±–∫–∏, retries/compensation, –¥–æ–ø—É—â–µ–Ω–∏—è.

### üé® 9. –ü—Ä–æ–º—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ UI/UX –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è Figma AI / Galileo / Uizard: —ç–∫—Ä–∞–Ω—ã, –ø–æ–ª—è/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –Ω–∞–≤–∏–≥–∞—Ü–∏—è, empty/error/loading, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è.

–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–¥–æ–±–∞–≤–ª—è–π –ø—Ä–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏; –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–π –æ—á–µ–≤–∏–¥–Ω–æ –Ω—É–∂–Ω—ã–µ)
A. –î–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å (Proposed)
B. –≠—Å–∫–∏–∑—ã API (Proposed) ‚Äî —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, JSON
C. –ù–§–¢ ‚Äî –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å, –∞—É–¥–∏—Ç, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
D. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî —Å–æ–±—ã—Ç–∏—è, —Å–≤–æ–π—Å—Ç–≤–∞, –≤–æ—Ä–æ–Ω–∫–∏; –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
E. –†–µ–ª–∏–∑ –∏ —Ä–∏—Å–∫–∏ ‚Äî —Ñ–ª–∞–≥–∏, A/B, –≥–≤–∞—Ä–¥rails, –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–∏—Å–∫–∏/mitigations
F. –ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫ ‚Äî –û—à–∏–±–∫–∞ | –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ | –°–æ–æ–±—â–µ–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ/–ø–æ–≤—Ç–æ—Ä

–ß–ï–ö-–õ–ò–°–¢ –ö–ê–ß–ï–°–¢–í–ê (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∫ —Å–æ–±–ª—é–¥–µ–Ω–∏—é)
- –í—Å–µ —Ä–∞–∑–¥–µ–ª—ã 1‚Äì9 –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏ ‚Äî —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ; —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ë–ó.
- –í User Flow –∏ BPMN-–ø—Ä–æ–º—Ç–µ –µ—Å—Ç—å –æ—à–∏–±–∫–∏/–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã.
- –£—á—Ç–µ–Ω—ã a11y –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è; –µ—Å—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å/–ø—Ä–∞–≤–∞.
- **–î–æ–ø—É—â–µ–Ω–∏—è** –ø–æ–º–µ—á–µ–Ω—ã —è–≤–Ω–æ; –±–µ–∑ ¬´—Å–∫—Ä—ã—Ç—ã—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π¬ª.

–°–§–û–†–ú–ò–†–£–ô –í–´–•–û–î –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.


–ü—Ä–æ–º—Ç –¥–ª—è –°—Ö–µ–º
–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –ü–æ–¥–≥–æ—Ç–æ–≤—å –î–í–ê –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞:
1) BPMN 2.0 (—Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –ø—É–ª—ã/–ª–µ–π–Ω—ã/–∑–∞–¥–∞—á–∏/—à–ª—é–∑—ã/—Å–æ–±—ã—Ç–∏—è/–¥–∞–Ω–Ω—ã–µ),
2) –î–æ–ø–æ–ª–Ω—è—é—â–∏–π User Flow (–ø–æ—à–∞–≥–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è).

–ö–û–ù–¢–ï–ö–°–¢
- –°–≤–æ–¥–∫–∞ –ë–ó: {{–°–í–û–î–ö–ê_–ò–ó_–ë–ó}}
- –ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª—è: {{–ü–†–ò–ú–ï–†–´_–°–¢–ò–õ–Ø}}
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: {{–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø}}
- –§–∏—á–∞: {{–û–ü–ò–°–ê–ù–ò–ï_–§–ò–ß–ò}}

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –î–õ–Ø BPMN
- –ü—É–ª—ã/–ª–µ–π–Ω—ã: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –í–µ–±/–ú–ü, API Gateway, Core/–±—ç–∫–µ–Ω–¥—ã, –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–ï–°–§/–Ω–∞–ª–æ–≥–∏, –ü–ª–∞—Ç–µ–∂–∏, –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è), Support/Ops.
- –°–æ–±—ã—Ç–∏—è: Start/End, –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ Message/Timer/Error.
- –ó–∞–¥–∞—á–∏ —Å —á—ë—Ç–∫–∏–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º (¬´–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –ï–°–§¬ª, ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ —à–∞–±–ª–æ–Ω–∞¬ª).
- –®–ª—é–∑—ã: —É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞, –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
- –û–±—ä–µ–∫—Ç—ã –¥–∞–Ω–Ω—ã—Ö: –∫–ª—é—á–µ–≤—ã–µ payload‚Äô—ã (PaymentDTO, TemplateDTO).
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: 4xx/5xx, —Å–µ—Ç—å, SLA-—Ç–∞–π–º–∞—É—Ç—ã, –æ—Ç–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º; —Ä–µ—Ç—Ä–∞–∏/–±–µ–∫–æ—Ñ—Ñ; –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
- SLA-–ø–æ–º–µ—Ç–∫–∏, –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã.

–û–ë–Ø–ó–ê–¢–ï–õ–ï–ù USER FLOW
- –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –∏ –ø—É—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–Ω–∞–ø—Ä., –ì–ª–∞–≤–Ω–∞—è ‚Üí –ü–ª–∞—Ç–µ–∂–∏ ‚Üí –®–∞–±–ª–æ–Ω—ã).
- –®–∞–≥–∏: –æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã ‚Üí –≤–≤–æ–¥ –ø–æ–ª–µ–π ‚Üí inline-–≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí —É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞.
- –°–æ—Å—Ç–æ—è–Ω–∏—è: –ø—É—Å—Ç–æ, –∑–∞–≥—Ä—É–∑–∫–∞/—Å–∫–µ–ª–µ—Ç–æ–Ω, —á–µ—Ä–Ω–æ–≤–∏–∫, –æ—Ñ–ª–∞–π–Ω/–ø–æ–≤—Ç–æ—Ä.
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å/–ø—Ä–∞–≤–∞/2FA.
- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê
A) –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ BPMN —Å —Å–≤—è–∑—è–º–∏.
B) –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π User Flow.
C) –ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫: –û—à–∏–±–∫–∞ | –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ | –°–æ–æ–±—â–µ–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ/–ø–æ–≤—Ç–æ—Ä.
D) **–î–æ–ø—É—â–µ–Ω–∏—è** (–µ—Å–ª–∏ –±—ã–ª–∏).
–Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π; —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —è—Ä–ª—ã–∫–∏ ‚Äî –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.


–ü—Ä–æ–º—Ç –¥–ª—è –î–∏–∑–∞–π–Ω–∞
–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π UI-–ø—Ä–æ—Ç–æ—Ç–∏–ø –≤ —Å—Ç–∏–ª–µ –∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ –∏–∑ –ë–ó.

–ö–û–ù–¢–ï–ö–°–¢
- –°–≤–æ–¥–∫–∞ –ë–ó: {{–°–í–û–î–ö–ê_–ò–ó_–ë–ó}}
- –ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª—è: {{–ü–†–ò–ú–ï–†–´_–°–¢–ò–õ–Ø}}
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: {{–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø}}
- –§–∏—á–∞: {{–û–ü–ò–°–ê–ù–ò–ï_–§–ò–ß–ò}}

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –≠–ö–†–ê–ù–´
1) –°–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤: –ø–æ–∏—Å–∫/—Ñ–∏–ª—å—Ç—Ä, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –ø–∞–≥–∏–Ω–∞—Ü–∏—è, –∫–Ω–æ–ø–∫–∞ ¬´–°–æ–∑–¥–∞—Ç—å¬ª, –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
2) –°–æ–∑–¥–∞–Ω–∏–µ/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ä–∞–∑–¥–µ–ª—ã (–û–±—â–µ–µ, –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π, –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞), inline-–ø–æ–¥—Å–∫–∞–∑–∫–∏, –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–ª—è.
3) –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: —Å–≤–æ–¥–∫–∞, –ø—Ä–∞–≤–∞, –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞.
4) –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–ª–∞—Ç–µ–∂–∞: –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ ‚Üí –∞–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
5) –£—Å–ø–µ—Ö –∏ –û—à–∏–±–∫–∞: –ø–æ–Ω—è—Ç–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã, CTA —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤.
6) –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –∏ –í–µ—Ä—Å–∏–∏: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫, –∏—Å—Ç–æ—Ä–∏—è, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.
7) –ù–∞—Å—Ç—Ä–æ–π–∫–∏/–ü—Ä–∞–≤–∞: —Ä–æ–ª–∏, —à–∞—Ä–∏–Ω–≥, –≤–∏–¥–∏–º–æ—Å—Ç—å (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π/–∫–æ–º–∞–Ω–¥–∞/–æ—Ä–≥).
8) –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å/–ê—É–¥–∏—Ç-–ª–æ–≥: –∫—Ç–æ/—á—Ç–æ/–∫–æ–≥–¥–∞.
9) –¢–æ—á–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: —Å–æ–±—ã—Ç–∏—è/—Å–≤–æ–π—Å—Ç–≤–∞.

–ö–û–ú–ü–û–ù–ï–ù–¢–´ –ò –í–ê–õ–ò–î–ê–¶–ò–Ø
- –ü–æ–ª—è: –∏–º—è, —Ç–∏–ø, –º–∞—Å–∫–∞, –ø—Ä–∞–≤–∏–ª–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ).
- –ö–Ω–æ–ø–∫–∏: primary/secondary/destructive, loading/disabled.
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å: inline-–æ—à–∏–±–∫–∏, –±–∞–Ω–Ω–µ—Ä—ã, —Ç–æ—Å—Ç—ã, —Å–∫–µ–ª–µ—Ç–æ–Ω—ã.
- –ù–∞–≤–∏–≥–∞—Ü–∏—è: —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏, –ø–æ–≤–µ–¥–µ–Ω–∏–µ ¬´–ù–∞–∑–∞–¥¬ª.
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: —è—Ä–ª—ã–∫–∏, –ø–æ—Ä—è–¥–æ–∫ —Ñ–æ–∫—É—Å–∞, –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫.
- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: RU/KZ/EN –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê
- –ò–µ—Ä–∞—Ä—Ö–∏—è —ç–∫—Ä–∞–Ω–æ–≤ + –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–æ —ç–∫—Ä–∞–Ω–∞–º.
- –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Ç–µ–∫—Å—Ç—ã –æ—à–∏–±–æ–∫ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—é.
- –ü—Ä–∏–º–µ—Ä—ã –º–∏–∫—Ä–æ–∫–æ–ø–∏—Ä–∞–π—Ç–∞ (–ª–µ–π–±–ª—ã, —Ö–µ–ª–ø-—Ç–µ–∫—Å—Ç—ã, –ø—É—Å—Ç–æ/–æ—à–∏–±–∫–∞/–∑–∞–≥—Ä—É–∑–∫–∞).
- –í–∞—Ä–∏–∞–Ω—Ç–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (empty/loading/error/success).
- Handoff –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (—Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏).
- **–î–æ–ø—É—â–µ–Ω–∏—è** –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö.
'''


class ResponseHandler(tornado.web.RequestHandler):
    async def __function(
        self,
        prompt: str,
        ms_uuid: str,
        content: List[dict] = None,
        chat_id: str = None
    ) -> list:
        try:
            if not content:
                content = []

            content.append({
                'role': 'user',
                'content': [
                    {'type': 'input_text', 'text': prompt}
                ]
            })

            input_content = []
            for c in content:
                if c['role'] in ['assistant']:
                    input_content.append({
                        'role': 'assistant',
                        'content': c['content']
                    })
                else:
                    input_content.append(c)

            if ai_client.has_files is True:
                response = await ai_client.responses.create(
                    model='gpt-4o-mini',
                    temperature=0.4,
                    instructions=__system_message__,
                    input=input_content,
                    stream=True,
                    tools=[
                        {'type': 'file_search', 'vector_store_ids': [ai_client.vector_store_id]},
                        {'type': 'web_search'}
                    ]
                )
            else:
                response = await ai_client.responses.create(
                    model='gpt-5-nano',
                    instructions=__system_message__,
                    input=input_content,
                    stream=True
                )

            chunks = ''
            async for event in response:
                if getattr(event, 'type', None) == 'response.output_text.delta':
                    delta = str(event.delta or '')
                    if not delta:
                        continue

                    chunks += delta

                    payload = json.dumps({
                        'text': delta,
                        'chat_id': chat_id
                    }, ensure_ascii=False)

                    if self.request.connection.stream.closed():
                        break

                    self.write(payload + '\n')
                    await self.flush()

            if not self.request.connection.stream.closed():
                self.write('[DONE]\n')
                await self.flush()

            content.append({
                'role': 'assistant',
                'content': chunks,
                'ms_uuid': ms_uuid
            })

            return content

        except (Exception,):
            traceback.print_exc()
            if not self.request.connection.stream.closed():
                self.write(json.dumps({
                    'text': '–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
                    'chat_id': chat_id
                }, ensure_ascii=False) + '\n')
                await self.flush()
            return content

    async def post(self):
        self.set_header('Content-Type', 'text/plain; charset=utf-8')
        self.set_header('Cache-Control', 'no-cache, no-transform')
        self.set_header('X-Accel-Buffering', 'no')

        data = json.loads(self.request.body)

        prompt = StrUtils.to_str(data.get('prompt'))
        chat_id = StrUtils.to_str(data.get('chat_id'))
        ms_uuid = StrUtils.to_str(data.get('ms_uuid')) or uuid4()

        if self.request.connection.stream.closed():
            return

        chat = None
        if chat_id:
            chat = await self.settings['db'].chats.find_one({
                '_id': ObjectId(chat_id)
            })

        chat_id = chat_id or str(ObjectId())
        await self.flush()

        content = await self.__function(
            prompt=prompt,
            content=chat['content'] if chat else None,
            ms_uuid=ms_uuid,
            chat_id=chat_id
        )

        await self.settings['db'].chats.update_one({'_id': ObjectId(chat_id)}, {'$set': {
            'is_active': True,
            'content': content,
            'updated_at' if chat else 'created_at': datetime.now()
        }}, upsert=True)

        if not self.request.connection.stream.closed():
            return self.finish()
