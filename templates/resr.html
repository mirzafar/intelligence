<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>AI Чат</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">


    <style>
        body {
            background: linear-gradient(135deg, #d9f7ff, #eaf3ff, #ffffff);
            font-family: 'Nunito', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* Offcanvas */
        .offcanvas {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 75%;
            max-width: 280px;
            background: #fff;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.25);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }

        .offcanvas-left {
            left: 0;
            transform: translateX(-100%);
        }

        .offcanvas-right {
            right: 0;
            transform: translateX(100%);
        }

        .offcanvas.show {
            transform: translateX(0);
        }

        .chat-box-h {
            max-height: calc(100vh - 140px);
        }

        @keyframes popup-scale {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-popup {
            animation: popup-scale 0.25s ease-out;
        }

        .user-bubble {
            background: linear-gradient(135deg, #06b6d491, #3b82f6d9);
            color: #fff;
            border-radius: 12px;
            padding: 8px 12px;
        }

        .assistant-bubble {
            background: #f1f5f9; /* светло-серый */
            color: #333;
            border-radius: 12px;
            padding: 8px 12px;
        }

        .chat-item {
            border-radius: 6px;
            transition: background-color .15s ease;
        }

        .chat-item:hover {
            background: #e5e7eb; /* темнее при наведении */
        }

        .chat-item.active {
            background: #cbd5e1; /* заметно темнее для активного */
        }

        .chat-item.active:hover {
            background: #94a3b8; /* ещё темнее при наведении активного */
        }

        #diagram-modal {
            z-index: 40 !important;
        }

        .diagram-d {
            min-width: 60%;
            min-height: 80%;
            max-height: 90%;
        }

        #success-popup, #error-popup, #loader {
            z-index: 50 !important;
        }

        #diagram-content svg,
        #diagram-content .mermaid > svg {
            display: block;
            max-width: 100%;
            height: auto; /* сохраняем пропорции */
        }

        /* (не обязательно) убираем внешние отступы, если mermaid их даёт */
        #diagram-content svg {
            margin: 0;
        }

        #diagram-content .svg-stage {
            position: absolute;
            inset: 0; /* top:0 right:0 bottom:0 left:0 */
        }

        /* сам SVG занимает 100% контейнера */
        #diagram-content .svg-stage > svg {
            display: block;
            width: 100% !important;
            height: 100% !important;
            overflow: visible; /* чтобы большие элементы не обрезались */
        }

    </style>
</head>
<body class="min-h-screen flex flex-col p-2 md:p-4">

<!-- Верхняя панель для мобилки -->
<header class="flex items-center justify-between bg-white/70 backdrop-blur p-3 rounded-lg mb-2 shadow md:hidden">
    <button id="menu-left" class="text-emerald-600 text-xl"><i class="fas fa-bars"></i></button>
    <h1 class="font-bold text-gray-700">AI Чат</h1>
    <button id="menu-right" class="text-emerald-600 text-xl"><i class="fas fa-folder"></i></button>
</header>

<!-- Основной контейнер -->
<div class="glass w-full flex-1 flex overflow-hidden">

    <!-- Левая панель (desktop) -->
    <aside id="left-sidebar"
           class="hidden md:flex w-1/4 bg-white/60 backdrop-blur p-4 border-r overflow-y-auto scrollbar-thin flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-sm font-semibold">История чатов</h2>
            <button id="new-chat" class="text-xs bg-green-400 text-white px-2 py-1 rounded hover:bg-green-500">+
                Новый
            </button>
        </div>
        <ul id="chat-list" class="space-y-2 text-sm text-gray-700"></ul>
    </aside>

    <!-- Центральная область -->
    <main class="flex-1 flex flex-col">
        <!-- Сообщения -->
        <div id="chat-box" class="flex-1 overflow-y-auto px-4 md:px-6 py-4 space-y-3 scrollbar-thin chat-box-h">
            <div class="text-gray-400 text-sm text-center">✨ Новый чат</div>
        </div>

        <!-- Ввод -->
        <div class="border-t p-3 bg-white/80 backdrop-blur">
            <div class="flex items-end gap-2">
        <textarea id="prompt-input" rows="2" placeholder="Введите сообщение..."
                  class="flex-1 resize-none bg-gray-100 p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-400 text-sm"></textarea>
                <button id="send-btn"
                        class="bg-cyan-400 px-4 py-2 rounded-lg text-sm shadow">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Правая панель (desktop) -->
    <aside id="right-sidebar"
           class="hidden lg:flex w-1/6 bg-white/60 backdrop-blur p-4 border-l scrollbar-thin overflow-y-auto flex-col">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-sm font-semibold">Файлы</h2>
        </div>
        <div id="files-list" class="space-y-2 text-sm text-gray-700"></div>
        <div class="mt-3">
            <input type="file" id="file-upload-input" multiple hidden/>
            <button id="upload-file-btn"
                    class="w-full text-xs bg-green-400 text-white px-2 py-1 rounded hover:bg-green-500">
                <i class="fas fa-plus mr-1 text-[10px]"></i> Добавить
            </button>
        </div>
    </aside>
</div>

<!-- Offcanvas слева -->
<div id="offcanvas-left" class="offcanvas offcanvas-left">
    <div class="p-4 border-b flex justify-between items-center">
        <h2 class="text-sm font-semibold">История чатов</h2>
        <button id="close-left"><i class="fas fa-times"></i></button>
    </div>
    <ul id="chat-list-mobile" class="p-4 space-y-2 text-sm text-gray-700"></ul>
</div>

<!-- Offcanvas справа -->
<div id="offcanvas-right" class="offcanvas offcanvas-right">
    <div class="p-4 border-b flex justify-between items-center">
        <h2 class="text-sm font-semibold">Файлы</h2>
        <button id="close-right"><i class="fas fa-times"></i></button>
    </div>
    <div id="files-list-mobile" class="p-4 space-y-2 text-sm text-gray-700"></div>
</div>

<!-- Лоадер -->
<div id="loader" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center space-y-4">
        <svg class="animate-spin h-10 w-10 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
        <span id="loader-text" class="text-gray-700 font-medium text-sm">Загрузка...</span>
    </div>
</div>

<div id="redirect-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
        <input id="redirect-filename"
               type="text"
               placeholder="Введите название файла..."
               class="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-emerald-400"/>
        <div class="flex justify-end gap-2">
            <button onclick="closeRedirectModal()"
                    class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm">
                Отмена
            </button>
            <button onclick="confirmRedirect()"
                    class="px-3 py-1 rounded bg-green-400 hover:bg-green-500 text-white text-sm">
                Подтвердить
            </button>
        </div>
    </div>
</div>

<!-- Успех -->
<div id="success-popup" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center space-y-3 animate-popup">
        <svg class="h-14 w-14 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
        <span id="success-text" class="text-gray-700 font-semibold text-base"></span>
    </div>
</div>

<div id="error-popup" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center space-y-3 animate-popup">
        <svg class="h-14 w-14 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        <span id="error-text" class="text-gray-700 font-semibold text-base"></span>
    </div>
</div>

<div id="diagram-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40 hidden">
    <div class="glass diagram-d relative rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        <!-- TOPBAR -->
        <div class="flex items-center justify-end px-4 py-3 border-b border-white/30 bg-white/40 backdrop-blur-md space-x-4 text-lg text-gray-600">
            <button id="copy-code" class="hover:text-blue-500" title="Скопировать"><i class="fas fa-copy"></i></button>
            <button id="download-svg" class="hover:text-blue-500" title="Скачать SVG"><i
                    class="fas fa-file-arrow-down"></i></button>
            <button id="toggle-code" class="hover:text-blue-500" title="Редактировать/Просмотр"><i
                    class="fas fa-code"></i></button>
            <button onclick="closeDiagram()" class="hover:text-red-500 text-xl" title="Закрыть"><i
                    class="fas fa-xmark"></i></button>
        </div>

        <!-- VIEW: диаграмма -->
        <div id="diagram-content"
             class="flex-1 relative p-0 overflow-hidden items-start justify-center bg-gradient-to-br from-gray-50 to-gray-100">
            <div class="text-gray-400 text-sm">Загрузка диаграммы...</div>
        </div>

        <!-- VIEW: редактор кода -->
        <textarea id="diagram-code"
                  class="hidden flex-1 min-h-0 w-full overflow-auto bg-gray-900 text-green-400 text-sm p-4 font-mono outline-none resize-none"></textarea>
    </div>
</div>

<!-- mermaid (если ещё не подключен) -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
<script> mermaid.initialize({startOnLoad: false}); </script>

<script>
    // Offcanvas toggle
    $('#menu-left').click(() => $('#offcanvas-left').addClass('show'));
    $('#close-left, #chat-box').click(() => $('#offcanvas-left').removeClass('show'));

    $('#menu-right').click(() => $('#offcanvas-right').addClass('show'));
    $('#close-right, #chat-box').click(() => $('#offcanvas-right').removeClass('show'));


    // Пример синхронизации файлов и чатов между desktop и mobile
    function syncLists() {
        $('#chat-list-mobile').html($('#chat-list').html());
        $('#files-list-mobile').html($('#files-list').html());
    }

    // Обновляем мобильные версии при изменениях
    setInterval(syncLists, 1000);

    let currentChatId = null;
    let availableFiles = [];

    let currentDiagramId = null;
    let currentDiagramCode = "";
    let isCodeView = false;          // <-- состояние вида
    let latestSVG = "";              // <-- последняя отрисованная SVG

    function showLoader(text = 'Загрузка...') {
        $('#loader-text').text(text);
        $('#loader').removeClass('hidden');
    }

    function hideLoader() {
        $('#loader').addClass('hidden');
    }

    function showSuccess() {
        console.log('showSuccess')
        $('#success-popup').removeClass('hidden').fadeIn(200);

        setTimeout(() => {
            $('#success-popup').fadeOut(300, () => {
                $('#success-popup').addClass('hidden');
            });
        }, 1500);
    }

    function showError(text = 'Ошибка') {
        $('#error-text').text(text);
        $('#error-popup').removeClass('hidden').fadeIn(200);

        setTimeout(() => {
            $('#error-popup').fadeOut(300, () => {
                $('#error-popup').addClass('hidden');
            });
        }, 2000);
    }


    function generateUUID() {
        return crypto.randomUUID();
    }

    function appendMessage(role, text, messageId = null) {
        const box = $('#chat-box');
        const id = messageId || 'msg-' + Date.now();

        const isUser = role === 'user';

        // Telegram colors
        const bubbleClass = isUser
            ? 'user-bubble self-end'
            : 'assistant-bubble self-start';
        // const userStyle = "background:#03a9f438; color:#1a1a1a; border-radius: 12px 12px 12px 12px;";
        // const assistantStyle = "background:#ffffff; color:#1a1a1a; border:1px solid #e5e7eb; border-radius: 12px 12px 12px 12px;";

        // Определяем стиль пузыря
        // const bubbleStyle = isUser ? userStyle : assistantStyle;

        // Кнопка redirect только для ассистента
        let redirectBtn = '';
        if (!isUser) {
            redirectBtn = `
              <button onclick="openRedirectModal('${id}')"
                      class="absolute top-1 right-2 text-gray-400 hover:text-emerald-600 transition"
                      title="Сохранить в базу" aria-label="Сохранить в базу">
                <i class="fas fa-download"></i>
              </button>
            `;
        }

        let diagramBtn = '';
        if (!isUser) {
            diagramBtn = `
              <button onclick="openDiagram('${id}')"
                      class="absolute top-1 right-8 text-gray-400 hover:text-indigo-600 transition"
                      title="Построить диаграмму" aria-label="Построить диаграмму">
                <i class="fas fa-project-diagram"></i>
              </button>
            `;
        }


        const bubble = `
          <div class="flex ${isUser ? 'justify-end' : 'justify-start'} w-full mb-1">
            <div id="${id}"
                 class="relative group max-w-[75%] px-3 py-2 text-sm whitespace-pre-wrap shadow-sm ${bubbleClass}"
                 ${!isUser ? 'ondblclick="editMessage(\'' + id + '\')"' : ''}>
              <div class="msg-text">${$('<div>').text(text).html()}</div>
              ${redirectBtn} ${diagramBtn}
            </div>
          </div>
        `;

        box.append(bubble);
        box.scrollTop(box[0].scrollHeight);
    }


    function editMessage(id) {
        const el = $('#' + id).find('.msg-text');
        el.attr('contenteditable', 'true')
            .addClass('outline-none rounded-md p-2 bg-white')
            .focus();

        // курсор в конец
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(el[0]);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);

        // при потере фокуса → автосохранение
        el.off('blur').on('blur', function () {
            saveMessage(id);
        });

        // при Enter → сохранить сразу
        el.off('keydown').on('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();   // блокируем перевод строки
                saveMessage(id);      // сохраняем
                el.blur();            // снимаем редактирование
            }
            // если Shift+Enter → просто оставить стандартное поведение (новая строка)
        });

    }


    function saveMessage(id) {
        const el = $('#' + id).find('.msg-text');
        const newText = el.text().trim();

        el.removeAttr('contenteditable')
            .removeClass('border border-emerald-400 rounded-md p-2 bg-white');

        fetch(`/api/chats/${currentChatId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'edit_message',
                messageId: id,
                text: newText
            })
        })
            .then(r => r.json())
            .then(res => {
                if (res._success) {
                    showSuccess();
                } else {
                    showError('');
                }
            })
            .catch(err => {
                showError('Ошибка');
            });
    }

    function redirectMessage(id, filename) {
        const el = $('#' + id).find('.msg-text');
        const text = el.text().trim();
        showLoader();

        fetch(`/api/chats/${currentChatId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                messageId: id,
                action: 'redirect',
                text,
                filename
            })
        })
            .then(r => r.json())
            .then(res => {
                showSuccess();
                hideLoader();
                loadFiles();
            })
            .catch(err => {
                alert('Ошибка перенаправления: ' + err.message);
                hideLoader();
            });
    }


    function loadChatHistory() {
        showLoader('Загрузка истории...');
        $.getJSON('/api/chats', function (data) {
            const chatList = $('#chat-list');
            chatList.empty();

            const items = data.items;
            if (items.length === 0) {
                chatList.append('<li class="text-gray-500 text-center py-1 text-xs">Нет истории чатов</li>');
            } else {
                items.forEach(chat => {
                    chatList.append(`
                        <li class="chat-item group flex items-center justify-between">
                            <button class="flex-1 text-left px-1.5 py-1 truncate text-xs"
                                    onclick="viewChat('${chat._id}', this)">
                                ${$('<div>').text(chat.title.substring(0, 25) + (chat.title.length > 25 ? '...' : '')).html()}
                            </button>
                            <button
                                class="delete-btn p-0.5 text-gray-400 hover:text-red-500 group-hover:visible"
                                onclick="deleteChat('${chat._id}', this)"
                            >
                                <i class="fas fa-trash-alt text-[10px]"></i>
                            </button>
                        </li>
                    `);
                });
            }
            hideLoader();
        }).fail(() => {
            alert('Ошибка загрузки истории');
            hideLoader();
        });
    }

    function loadFiles() {
        showLoader('Загрузка файлов...');
        $.getJSON('/api/files', function (data) {
            const filesList = $('#files-list');
            filesList.empty();
            availableFiles = data.items || [];

            if (availableFiles.length === 0) {
                filesList.append('<div class="text-gray-500 text-center py-1 text-xs">Нет файлов</div>');
            } else {
                availableFiles.forEach(file => {
                    filesList.append(`
                        <div class="file-item flex items-center justify-between p-1.5 bg-white rounded border text-xs">
                            <a target="_blank" href="/api/files/${file._id}/download" class="truncate flex-1 text-emerald-600 hover:underline">
                                ${$('<div>').text(file.title.substring(0, 20) + (file.title.length > 20 ? '...' : '')).html()}
                            </a>
                            <div class="flex space-x-1">
                                <button onclick="deleteFile('${file._id}', this)" class="text-gray-500 hover:text-red-500 p-0.5">
                                    <i class="fas fa-trash-alt text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    `);
                });
            }
            hideLoader();
        }).fail(() => {
            alert('Ошибка загрузки файлов');
            hideLoader();
        });
    }

    function deleteFile(fileId, button) {
        if (!confirm('Удалить этот файл?')) return;

        $(button).prop('disabled', true).html('<i class="fas fa-spinner fa-spin text-[10px]"></i>');

        $.ajax({
            url: `/api/files/${fileId}`,
            type: 'DELETE',
            success: function (response) {
                if (response._success) {
                    loadFiles();
                } else {
                    alert('Ошибка: ' + (response.message || 'Не удалось удалить файл'));
                    $(button).prop('disabled', false).html('<i class="fas fa-trash-alt text-[10px]"></i>');
                }
            },
            error: function () {
                alert('Ошибка соединения');
                $(button).prop('disabled', false).html('<i class="fas fa-trash-alt text-[10px]"></i>');
            }
        });
    }

    function deleteChat(chatId, button) {
        if (!confirm('Удалить этот чат?')) return;

        $(button).prop('disabled', true).html('<i class="fas fa-spinner fa-spin text-[10px]"></i>');

        $.ajax({
            url: `/api/chats/${chatId}`,
            type: 'DELETE',
            success: function (response) {
                if (response._success) {
                    if (currentChatId === chatId) {
                        $('#new-chat').click();
                    }
                    loadChatHistory();
                } else {
                    alert('Ошибка: ' + (response.message || 'Не удалось удалить чат'));
                    $(button).prop('disabled', false).html('<i class="fas fa-trash-alt text-[10px]"></i>');
                }
            },
            error: function () {
                alert('Ошибка соединения');
                $(button).prop('disabled', false).html('<i class="fas fa-trash-alt text-[10px]"></i>');
            }
        });
    }

    function viewChat(chatId, el) {
        showLoader('Загрузка чата...');
        $('#offcanvas-left, #offcanvas-right').removeClass('show');

        $.getJSON(`/api/chats/${chatId}`, function (chat) {
            const item = chat.content;
            const box = $('#chat-box');
            box.empty();
            item.forEach(item => {
                if (item.role === 'user') appendMessage('user', item.text);
                if (item.role === 'assistant') appendMessage('assistant', item.text, item.ms_uuid);
            });

            currentChatId = chatId;

            // установить активный элемент в desktop-списке
            $('#chat-list .chat-item').removeClass('active');
            if (el) $(el).closest('.chat-item').addClass('active');

            hideLoader();
        }).fail(() => {
            alert('Ошибка загрузки чата');
            hideLoader();
        });
    }


    function uploadFiles(files) {
        if (files.length === 0) return;

        showLoader('Загрузка файлов...');
        const formData = new FormData();

        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        $.ajax({
            url: '/api/files',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response._success) {
                    loadFiles();
                } else {
                    alert('Ошибка: ' + (response.message || 'Не удалось загрузить файлы'));
                }
                hideLoader();
            },
            error: function () {
                alert('Ошибка соединения при загрузке');
                hideLoader();
            }
        });
    }

    async function openDiagram(id) {
        currentDiagramId = id;
        isCodeView = false;
        $('#diagram-modal').removeClass('hidden');
        $('#diagram-content').removeClass('hidden').html('<div class="text-gray-500 text-center mt-10">Загрузка...</div>');
        $('#diagram-code').addClass('hidden');

        try {
            const res = await fetch(`/api/diagrams/${currentChatId}/${id}`);
            const data = await res.json();

            if (!data || !data.code) {
                $('#diagram-content')
                    .removeClass('p-6')        // убираем внутренние отступы, чтобы занять всё
                    .addClass('p-0 relative')  // якорь для absolute
                    .empty()
                    .append(`
                    <div id="diagram-empty"
                         class="absolute inset-0 flex items-center justify-center">
                      <button onclick="generateDiagram('${id}')"
                              class="px-6 py-3 bg-teal-500 text-black rounded-lg shadow hover:bg-teal-700">
                        <i class="fas fa-magic mr-2"></i> Генерировать диаграмму
                      </button>
                    </div>
                  `);
                return;
            }

            currentDiagramCode = data.code;
            console.log(currentDiagramCode.length);
            await renderDiagram(currentDiagramCode);
            bindToolbar(); // навесим обработчики на иконки

        } catch (err) {
            $('#diagram-content').html('<div class="text-red-500">Ошибка: ' + err.message + '</div>');
        }
    }

    function bindToolbar() {
        // копировать код
        $('#copy-code').off().on('click', () => {
            navigator.clipboard.writeText(currentDiagramCode);
            showSuccess();
        });

        // скачать svg (последний отрисованный)
        $('#download-svg').off().on('click', () => {
            if (!latestSVG) return;
            const blob = new Blob([latestSVG], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagram.svg';
            a.click();
            URL.revokeObjectURL(url);
        });

        // переключатель "редактор ⇄ диаграмма"
        $('#toggle-code').off().on('click', async () => {
            if (!isCodeView) {
                if (diagramPanZoom) {
                    diagramPanZoom.destroy();
                    diagramPanZoom = null;
                }
                $(window).off('resize.diagram');
                $('#diagram-content').addClass('hidden');
                $('#diagram-code').removeClass('hidden').val(currentDiagramCode).focus();
                isCodeView = true;
            } else {
                $('#diagram-content').removeClass('hidden');
                await renderDiagram(currentDiagramCode);
                isCodeView = false;
            }
        });
    }

    let diagramPanZoom = null; // если ещё не объявлен

    async function renderDiagram(code) {
        try {
            const {svg} = await mermaid.render('generatedDiagram', code);

            latestSVG = svg;
            const $dc = $('#diagram-content');

            // убираем плейсхолдер/кнопку, готовим сцену под полный размер
            $dc.find('#diagram-empty').remove();
            $dc.html('<div class="svg-stage"></div>');

            // вставляем svg
            const $stage = $dc.find('.svg-stage');
            $stage.html(svg);

            // на всякий случай: принудительно растянуть на весь контейнер
            const svgEl = $stage.find('svg').get(0);
            if (svgEl) {
                svgEl.removeAttribute('width');
                svgEl.removeAttribute('height');
                svgEl.style.width = '100%';
                svgEl.style.height = '100%';
                svgEl.style.overflow = 'visible';
                // если нет viewBox — попробуем выставить из bbox (редко нужно)
                if (!svgEl.getAttribute('viewBox')) {
                    const bb = svgEl.getBBox ? svgEl.getBBox() : null;
                    if (bb) svgEl.setAttribute('viewBox', `${bb.x} ${bb.y} ${bb.width} ${bb.height}`);
                }
                svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');
            }

            // пересоздаём pan/zoom (жесты: колесо/пинч/drag/даблклик)
            if (diagramPanZoom) {
                diagramPanZoom.destroy();
                diagramPanZoom = null;
            }
            diagramPanZoom = svgPanZoom(svgEl, {
                panEnabled: true,
                zoomEnabled: true,
                controlIconsEnabled: false,
                fit: true,
                center: true,
                contain: true,            // стараться держать SVG в контейнере
                minZoom: 0.2,
                maxZoom: 10,
                zoomScaleSensitivity: 0.2,
                dblClickZoomEnabled: true,
                mouseWheelZoomEnabled: true
            });

            // подогнать под контейнер
            diagramPanZoom.resize();
            diagramPanZoom.fit();
            diagramPanZoom.center();

            // ресайз окна → подгоняем
            $(window).off('resize.diagram').on('resize.diagram', () => {
                if (!diagramPanZoom) return;
                diagramPanZoom.resize();
                diagramPanZoom.fit();
                diagramPanZoom.center();
            });

            // режим: диаграмма
            $('#diagram-code').addClass('hidden');
            isCodeView = false;
        } catch (err) {
            console.log(err);
            $('#diagram-content').html('<div class="text-red-500">Ошибка рендера</div>');
        }
    }

    function closeDiagram() {
        if (diagramPanZoom) {
            diagramPanZoom.destroy();
            diagramPanZoom = null;
        }
        $(window).off('resize.diagram');
        $('#diagram-modal').addClass('hidden');
        $('#diagram-content').removeClass('hidden').empty();
        $('#diagram-code').addClass('hidden');
        isCodeView = false;
        latestSVG = "";
    }


    async function generateDiagram(id) {
        showLoader('Генерация...');
        try {
            await fetch(`/api/diagrams/${currentChatId}/${id}`, {method: 'POST'})
                .then(r => r.json())
                .then(res => {
                    hideLoader();
                    openDiagram(id);
                })
                .catch(err => {
                    showError('Ошибка генерации');
                    hideLoader();
                });

        } catch (err) {
            hideLoader();
            showError('Ошибка генерации');
        }
    }

    $('#diagram-code').on('input', async function () {
        currentDiagramCode = $(this).val();
        try {
            await fetch(`/api/diagrams/${currentDiagramId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code: currentDiagramCode})
            });
            // (опционально) лайтовый визуальный отклик можно сделать тут
        } catch (err) {
            console.error('Ошибка сохранения', err);
        }
    });


    $(document).ready(function () {
        loadChatHistory();
        loadFiles();

        $('#upload-file-btn').click(() => $('#file-upload-input').click());

        $('#prompt-input').on('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // чтобы не было перевода строки
                $('#send-btn').click();
            }
        });

        $('#prompt-input').off('input').on('input', function () {
            this.style.height = 'auto';          // сброс
            this.style.height = this.scrollHeight + 'px'; // новая высота
        });

        $('#file-upload-input').on('change', function () {
            const files = Array.from(this.files);
            if (files.length > 0) {
                uploadFiles(files);
                $(this).val('');
            }
        });

        $('#send-btn').click(async function () {
            const prompt = $('#prompt-input').val().trim();
            if (!prompt) return alert('Введите сообщение');

            let ms_uuid = generateUUID();

            appendMessage('user', prompt);
            showLoader('Думаю...');

            try {
                const response = await fetch('/api/response', {
                    method: 'POST',
                    body: JSON.stringify({
                        prompt: prompt,
                        chat_id: currentChatId,
                        ms_uuid: ms_uuid
                    })
                });

                if (!response.ok) throw new Error(`Ошибка ${response.status}`);
                if (!response.body) throw new Error('Поток не поддерживается');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, {stream: true});
                    const parsedData = JSON.parse(chunk);

                    console.log('chunk:', parsedData);
                    assistantMessage += parsedData.text;
                    currentChatId = parsedData.chat_id;

                    $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    $('#prompt-input').val('');
                }
                appendMessage('assistant', assistantMessage, ms_uuid);


            } catch (error) {
                appendMessage('assistant', `Ошибка: ${error.message}`);
            } finally {
                hideLoader();
                loadChatHistory();
            }
        });


        $('#new-chat').click(function () {
            $('#attached-files').empty();
            $('#chat-box').html('<div class="text-gray-400 text-sm text-center">Новый чат</div>');
            currentChatId = null;
            loadFiles();

            // убираем активность у всех пунктов истории
            $('#chat-list .chat-item').removeClass('active');
            $('#chat-list-mobile .chat-item').removeClass('active'); // если хочешь и для мобилки
        });
    });

    let redirectMessageId = null; // временно хранит ID сообщения

    function openRedirectModal(id) {
        redirectMessageId = id;
        $('#redirect-filename').val(''); // очистка поля
        $('#redirect-modal').removeClass('hidden');
        $('#redirect-filename').focus();
    }

    function closeRedirectModal() {
        $('#redirect-modal').addClass('hidden');
        redirectMessageId = null;
    }

    function confirmRedirect() {
        const filename = $('#redirect-filename').val().trim();
        if (!filename) {
            alert('Введите название файла');
            return;
        }
        $('#redirect-modal').addClass('hidden');

        // вызываем redirectMessage с именем файла
        redirectMessage(redirectMessageId, filename);
        redirectMessageId = null;
    }
</script>

</body>
</html>
